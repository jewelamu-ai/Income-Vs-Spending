<!DOCTYPE html>
<!-- 
Budget Tracker Pro - Cloud Sync
A professional budget tracking application with Firebase integration
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker Pro - Cloud Sync</title>
    
    <meta name="description" content="Professional budget tracking app with cloud sync, analytics, and financial management">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%234f46e5'/><rect x='48' y='64' width='96' height='64' fill='white'/><text x='96' y='112' font-family='Arial' font-size='48' fill='white' text-anchor='middle'>$</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        /* Prevent login screen flash on page load */
        #loginScreen,
        #mainApp {
            display: none !important;
        }
        
        body.auth-ready #loginScreen.show-login {
            display: block !important;
        }
        
        body.auth-ready #mainApp.show-app {
            display: block !important;
        }
        
        .tab-active { color: #4f46e5; font-weight: 600; }
        .tab-active svg { stroke: #4f46e5; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Filter button pop animation */
        .filter-btn-pop {
            animation: pop 0.3s ease-in-out;
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Active filter button styles */
        .filter-btn-active {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .filter-btn-active.filter-all { background-color: #4f46e5 !important; color: white !important; border-color: #4f46e5 !important; }
        .filter-btn-active.filter-income { background-color: #16a34a !important; color: white !important; border-color: #16a34a !important; }
        .filter-btn-active.filter-expense { background-color: #dc2626 !important; color: white !important; border-color: #dc2626 !important; }
        .filter-btn-active.filter-transfer { background-color: #2563eb !important; color: white !important; border-color: #2563eb !important; }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            /* Hide labels on small screens */
            .mobile-hide-label { display: none; }
            
            /* Stack filter buttons vertically on mobile */
            .filter-buttons-mobile { flex-wrap: wrap; }
            
            /* Adjust padding and margins for mobile */
            .mobile-compact { padding: 0.75rem !important; }
            
            /* Make modals full screen on mobile */
            .modal-mobile-full { max-width: 100% !important; margin: 0 !important; height: 100vh !important; border-radius: 0 !important; }
            
            /* Smaller text on mobile */
            .mobile-text-sm { font-size: 0.875rem !important; }
            
            /* Hide email on very small screens */
            @media (max-width: 640px) {
                #userEmail { display: none !important; }
            }
        }
        
        /* Ensure bottom navigation is always on top */
        .bottom-nav { z-index: 30 !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen">
    
    <!-- Firebase Configuration Notice -->
    <div id="firebaseNotice" class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
        <div class="max-w-6xl mx-auto">
            <p class="text-sm text-yellow-700">
                ⚠️ <strong>Firebase Setup Required:</strong> Please configure your Firebase credentials in the JavaScript section below. 
                <a href="#setup-instructions" class="underline font-semibold">See setup instructions</a>
            </p>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center p-4 bg-gradient-to-br from-indigo-50 via-white to-purple-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Budget Tracker Pro</h1>
                <p class="text-gray-600">Cloud-synced expense tracking</p>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Email" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="loginPassword" placeholder="Password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <button onclick="loginUser()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg">
                    Sign In
                </button>
                <button onclick="showForgotPassword()" class="w-full text-indigo-600 text-sm hover:text-indigo-800 underline">
                    Forgot Password?
                </button>
                <button onclick="showRegisterForm()" class="w-full bg-white text-indigo-600 border-2 border-indigo-600 py-3 rounded-lg font-semibold hover:bg-indigo-50">
                    Create Account
                </button>
                <div id="loginError" class="text-red-600 text-sm text-center hidden"></div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="space-y-4 hidden">
                <input type="email" id="registerEmail" placeholder="Email" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="registerPasswordConfirm" placeholder="Confirm Password" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <button onclick="registerUser()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg">
                    Create Account
                </button>
                <button onclick="showLoginForm()" class="w-full bg-white text-gray-600 border-2 border-gray-300 py-3 rounded-lg font-semibold hover:bg-gray-50">
                    Back to Login
                </button>
                <div id="registerError" class="text-red-600 text-sm text-center hidden"></div>
            </div>

            <!-- Forgot Password Form -->
            <div id="forgotPasswordForm" class="space-y-4 hidden">
                <p class="text-gray-600 text-sm text-center">Enter your email address and we'll send you a link to reset your password.</p>
                <input type="email" id="forgotEmail" placeholder="Email" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                <button onclick="resetPassword()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg">
                    Send Reset Link
                </button>
                <button onclick="showLoginForm()" class="w-full bg-white text-gray-600 border-2 border-gray-300 py-3 rounded-lg font-semibold hover:bg-gray-50">
                    Back to Login
                </button>
                <div id="forgotError" class="text-red-600 text-sm text-center hidden"></div>
                <div id="forgotSuccess" class="text-green-600 text-sm text-center hidden"></div>
            </div>

            <!-- Loading Spinner -->
            <div id="authLoading" class="hidden text-center">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Please wait...</p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until logged in) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg">
            <div class="max-w-6xl mx-auto p-4">
                <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                    <div class="flex items-center gap-2">
                        <svg class="w-6 h-6 md:w-7 md:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                        <h1 class="text-lg md:text-2xl font-bold">Budget Tracker Pro</h1>
                    </div>
                    <div class="flex gap-1 md:gap-2 items-center flex-wrap">
                        <span id="userEmail" class="text-sm opacity-90 hidden md:block"></span>
                        <button onclick="openSettingsModal()" class="bg-white/20 hover:bg-white/30 px-2 md:px-3 py-1.5 md:py-2 rounded-lg text-xs md:text-sm">Settings</button>
                        <button onclick="exportData()" class="bg-white/20 hover:bg-white/30 px-2 md:px-3 py-1.5 md:py-2 rounded-lg text-xs md:text-sm">Export</button>
                        <button onclick="logoutUser()" class="bg-white/20 hover:bg-white/30 px-2 md:px-3 py-1.5 md:py-2 rounded-lg text-xs md:text-sm">Logout</button>
                    </div>
                </div>

                <!-- Sync Status -->
                <div id="syncStatus" class="text-xs opacity-75 mb-3 flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span>Synced</span>
                </div>

                <!-- Auto-logout Status -->
                <div id="autoLogoutStatus" class="text-xs opacity-75 flex items-center gap-2 hidden">
                    <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                    <span>Auto-logout in 5 minutes of inactivity</span>
                </div>

                <!-- Account Selector -->
                <div class="mb-4">
                    <select id="accountSelector" onchange="switchAccount()" class="bg-white/20 text-white border border-white/30 rounded-lg px-4 py-2 w-full backdrop-blur-sm">
                        <option value="default">All Accounts</option>
                    </select>
                </div>

                <!-- Balance Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl md:rounded-2xl p-3 md:p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-1 md:mb-2">
                            <div class="text-xs md:text-sm opacity-90">Income</div>
                            <svg class="w-4 h-4 md:w-6 md:h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <p id="totalIncome" class="text-lg md:text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-0.5 md:mt-1">This month</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl md:rounded-2xl p-3 md:p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-1 md:mb-2">
                            <div class="text-xs md:text-sm opacity-90">Expenses</div>
                            <svg class="w-4 h-4 md:w-6 md:h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <p id="totalExpense" class="text-lg md:text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-0.5 md:mt-1">This month</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl md:rounded-2xl p-3 md:p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-1 md:mb-2">
                            <div class="text-xs md:text-sm opacity-90">Balance</div>
                            <svg class="w-4 h-4 md:w-6 md:h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <p id="balance" class="text-lg md:text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-0.5 md:mt-1">Available</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl md:rounded-2xl p-3 md:p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-1 md:mb-2">
                            <div class="text-xs md:text-sm opacity-90">Budget Left</div>
                            <svg class="w-4 h-4 md:w-6 md:h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <p id="budgetLeft" class="text-lg md:text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-0.5 md:mt-1">Remaining</div>
                    </div>
                </div>

                <!-- Welcome Section -->
                <div class="mt-6 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-6 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold">Welcome back!</h2>
                            <p class="text-indigo-100 text-sm">Here's your financial overview</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm opacity-90" id="currentDate"></p>
                            <p class="text-xs opacity-75">Today</p>
                        </div>
                    </div>
                </div>

                <!-- Financial Position Section -->
                <div class="mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Financial Position</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Income Sources -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-800">Income Sources</h4>
                            </div>
                            <div id="incomeSourcesList" class="space-y-3">
                                <!-- Income sources will be populated here -->
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-700">Total Assets</span>
                                    <span id="totalAssetsValue" class="font-bold text-green-600 text-lg">GHS0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Liabilities -->
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800">Liabilities</h4>
                                </div>
                                <button onclick="showLiabilitiesBreakdown()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                                    View Details →
                                </button>
                            </div>
                            <div id="liabilitiesList" class="space-y-3">
                                <!-- Liabilities will be populated here -->
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold text-gray-700">Total Liabilities</span>
                                    <span id="totalLiabilitiesValue" class="font-bold text-red-600 text-lg">GHS0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Net Worth Summary -->
                    <div class="mt-6 bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-semibold">Net Worth</h4>
                                <p class="text-gray-300 text-sm">Assets minus Liabilities</p>
                            </div>
                            <div class="text-right">
                                <p id="netWorthValue" class="text-3xl font-bold">GHS0.00</p>
                                <p class="text-sm text-gray-300">Current Position</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg bottom-nav">
            <div class="max-w-6xl mx-auto flex">
                <button onclick="switchTab('transactions')" id="tabTransactions" class="tab-active flex-1 py-3 px-2 flex flex-col items-center justify-center text-xs">
                    <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span>Transactions</span>
                </button>
                <button onclick="switchTab('budgets')" id="tabBudgets" class="flex-1 py-3 px-2 flex flex-col items-center justify-center text-xs text-gray-600">
                    <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>Budgets</span>
                </button>
                <button onclick="switchTab('analytics')" id="tabAnalytics" class="flex-1 py-3 px-2 flex flex-col items-center justify-center text-xs text-gray-600">
                    <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>Analytics</span>
                </button>
                <button onclick="switchTab('assets')" id="tabAssets" class="flex-1 py-3 px-2 flex flex-col items-center justify-center text-xs text-gray-600">
                    <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span>Assets</span>
                </button>
                <button onclick="switchTab('liabilities')" id="tabLiabilities" class="flex-1 py-3 px-2 flex flex-col items-center justify-center text-xs text-gray-600">
                    <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span>Liabilities</span>
                </button>
                <button onclick="switchTab('accounts')" id="tabAccounts" class="flex-1 py-3 px-2 flex flex-col items-center justify-center text-xs text-gray-600">
                    <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    <span>Accounts</span>
                </button>
                <button onclick="switchTab('reminders')" id="tabReminders" class="flex-1 py-3 px-2 flex flex-col items-center justify-center text-xs text-gray-600">
                    <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>Reminders</span>
                </button>
            </div>
        </div>

        <!-- Main Content Container -->
        <div class="max-w-6xl mx-auto p-2 md:p-4 pb-24 md:pb-20">
            <!-- Transactions Tab -->
            <div id="contentTransactions" class="tab-content">
                <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                    <div class="flex gap-2 flex-wrap filter-buttons-mobile">
                        <button onclick="setFilter('all', event)" id="filterAll" class="filter-btn px-3 py-2 text-sm rounded-lg bg-indigo-600 text-white border-2 border-indigo-600 transition-all duration-200 hover:shadow-lg">All</button>
                        <button onclick="setFilter('income', event)" id="filterIncome" class="filter-btn px-3 py-2 text-sm rounded-lg bg-green-100 text-green-700 border-2 border-green-200 transition-all duration-200 hover:shadow-lg">Income</button>
                        <button onclick="setFilter('expense', event)" id="filterExpense" class="filter-btn px-3 py-2 text-sm rounded-lg bg-red-100 text-red-700 border-2 border-red-200 transition-all duration-200 hover:shadow-lg">Expense</button>
                        <button onclick="setFilter('transfer', event)" id="filterTransfer" class="filter-btn px-3 py-2 text-sm rounded-lg bg-blue-100 text-blue-700 border-2 border-blue-200 transition-all duration-200 hover:shadow-lg">Transfers</button>
                    </div>
                    <div class="flex gap-2 items-center flex-wrap w-full md:w-auto">
                        <input type="text" id="searchInput" placeholder="Search..." class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 flex-1 md:flex-initial" oninput="handleSearch()">
                        <div class="flex items-center gap-1">
                            <label for="dateFrom" class="text-xs text-gray-600 mobile-hide-label">From:</label>
                            <input type="date" id="dateFrom" class="px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="handleSearch()">
                        </div>
                        <div class="flex items-center gap-1">
                            <label for="dateTo" class="text-xs text-gray-600 mobile-hide-label">To:</label>
                            <input type="date" id="dateTo" class="px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="handleSearch()">
                        </div>
                        <button onclick="openTransactionModal()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold whitespace-nowrap">+ Add</button>
                    </div>
                </div>
                <div id="transactionsList" class="bg-white rounded-xl shadow-md"></div>
            </div>

            <!-- Budgets Tab -->
            <div id="contentBudgets" class="tab-content hidden">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Category Budgets</h2>
                    <button onclick="openBudgetModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm">+ Add Budget</button>
                </div>
                <div id="budgetsList"></div>
            </div>

            <!-- Analytics Tab -->
            <div id="contentAnalytics" class="tab-content hidden">
                <div class="mb-4">
                    <select id="analyticsType" class="px-4 py-2 border rounded-lg">
                        <option value="category">By Category</option>
                        <option value="monthly">Monthly Trend</option>
                        <option value="comparison">Income vs Expense</option>
                    </select>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4">
                    <canvas id="analyticsChart"></canvas>
                </div>
                <div id="analyticsSummary" class="mt-4"></div>
            </div>

            <!-- Recurring Tab -->
            <div id="contentRecurring" class="tab-content hidden">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Recurring Transactions</h2>
                    <button onclick="openRecurringModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm">+ Add Recurring</button>
                </div>
                <div id="recurringList"></div>
            </div>

            <!-- Assets Tab -->
            <div id="contentAssets" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Asset Manager</h2>
                    <p class="text-gray-600">Track your valuable assets and investments</p>
                </div>

                <!-- Asset Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm opacity-90">Total Assets</div>
                            <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <p id="totalAssetsValue" class="text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-1">All assets combined</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm opacity-90">Real Estate</div>
                            <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                            </svg>
                        </div>
                        <p id="realEstateValue" class="text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-1">Properties & land</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm opacity-90">Investments</div>
                            <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <p id="investmentsValue" class="text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-1">Stocks & investments</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm opacity-90">Loans Given</div>
                            <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                            </svg>
                        </div>
                        <p id="loansValue" class="text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-1">Money lent to others</div>
                    </div>
                </div>

                <!-- Add Asset Button -->
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Your Assets</h3>
                    <button onclick="openAssetModal()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-shadow">
                        + Add Asset
                    </button>
                </div>

                <!-- Assets List -->
                <div id="assetsList"></div>
            </div>

            <!-- Liabilities Tab -->
            <div id="contentLiabilities" class="tab-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Liability Manager</h2>
                    <p class="text-gray-600">Track your debts, loans, and credit facilities</p>
                </div>

                <!-- Liability Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm opacity-90">Total Liabilities</div>
                            <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <p id="liabilitiesTabTotalValue" class="text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-1">All debts combined</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm opacity-90">Bank Loans</div>
                            <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <p id="bankLoansValue" class="text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-1">Loans from banks</div>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm opacity-90">Credit Cards</div>
                            <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                        </div>
                        <p id="creditCardsValue" class="text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-1">Credit card balances</div>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-2xl p-4 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm opacity-90">Personal Loans</div>
                            <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <p id="personalLoansValue" class="text-2xl font-bold">GHS0.00</p>
                        <div class="text-xs opacity-75 mt-1">Loans from friends/family</div>
                    </div>
                </div>

                <!-- Add Liability Button -->
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Your Liabilities</h3>
                    <button onclick="openLiabilityModal()" class="bg-gradient-to-r from-red-600 to-pink-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:shadow-lg transition-shadow">
                        + Add Liability
                    </button>
                </div>

                <!-- Liabilities List -->
                <div id="liabilitiesList"></div>
            </div>

            <!-- Accounts Tab -->
            <div id="contentAccounts" class="tab-content hidden">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Accounts & Assets</h2>
                    <button onclick="openAccountModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm">+ Add Account</button>
                </div>
                <div id="accountsList"></div>
            </div>

            <!-- Reminders Tab -->
            <div id="contentReminders" class="tab-content hidden">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Bill Reminders</h2>
                    <button onclick="openReminderModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm">+ Add Reminder</button>
                </div>
                <div id="remindersList"></div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button - Only show when logged in -->
    <button id="fabButton" onclick="openTransactionModal()" class="hidden fixed bottom-20 md:bottom-6 right-4 md:right-6 w-12 h-12 md:w-14 md:h-14 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full shadow-lg hover:shadow-xl transition-shadow flex items-center justify-center z-40">
        <svg class="w-5 h-5 md:w-6 md:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
    </button>

    <!-- All Modals (Transaction, Budget, Account, Reminder) - Same as before -->
    <div id="transactionModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-md w-full p-4 md:p-6 my-4 md:my-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Add Transaction</h2>
                <button onclick="closeTransactionModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Transaction Type Selection -->
            <div class="mb-6">
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="setType('income')" id="typeIncome" class="p-4 rounded-2xl border-2 border-gray-200 hover:border-green-300 transition-colors group">
                        <div class="flex flex-col items-center space-y-2">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200 transition-colors">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                            <span class="font-medium text-gray-700">Income</span>
                        </div>
                    </button>
                    <button onclick="setType('expense')" id="typeExpense" class="p-4 rounded-2xl border-2 border-red-500 bg-red-50 text-red-700">
                        <div class="flex flex-col items-center space-y-2">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                            <span class="font-medium">Expense</span>
                        </div>
                    </button>
                    <button onclick="setType('transfer')" id="typeTransfer" class="p-4 rounded-2xl border-2 border-gray-200 hover:border-blue-300 transition-colors group">
                        <div class="flex flex-col items-center space-y-2">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                            </div>
                            <span class="font-medium text-gray-700">Transfer</span>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Form Fields -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">GHS</span>
                        <input type="number" id="amount" step="0.01" placeholder="0.00" class="w-full pl-16 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="category" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>

                <div id="accountField">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account</label>
                    <select id="accountSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                </div>

                <div id="transferFields" class="hidden">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">From Account</label>
                            <select id="fromAccountSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">To Account</label>
                            <select id="toAccountSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date & Time</label>
                    <input type="datetime-local" id="date" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <input type="text" id="description" placeholder="What was this for?" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <button onclick="addTransaction()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold text-lg hover:shadow-lg transition-shadow mt-6">
                    Add Transaction
                </button>
            </div>
        </div>
    </div>

    <div id="budgetModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-md w-full p-4 md:p-6 my-4 md:my-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Set Budget</h2>
                <button onclick="closeBudgetModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            <div class="space-y-3">
                <select id="budgetCategory" class="w-full px-4 py-3 border rounded-lg"></select>
                <input type="number" id="budgetAmount" step="0.01" placeholder="Budget Amount" class="w-full px-4 py-3 border rounded-lg">
                <select id="budgetPeriod" class="w-full px-4 py-3 border rounded-lg">
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <button onclick="addBudget()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold">Set Budget</button>
            </div>
        </div>
    </div>

    <div id="accountModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-md w-full p-4 md:p-6 my-4 md:my-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Add Account</h2>
                <button onclick="closeAccountModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Form Fields -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Name</label>
                    <input type="text" id="accountName" placeholder="e.g., Main Checking, Savings" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Type</label>
                    <select id="accountType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="cash">💵 Cash</option>
                        <option value="bank">🏦 Bank Account</option>
                        <option value="credit">💳 Credit Card</option>
                        <option value="mtn-momo">📱 MTN MoMo</option>
                        <option value="telecel-cash">📞 Telecel Cash</option>
                        <option value="investment">📈 Investment</option>
                        <option value="asset">🏠 Asset</option>
                        <option value="debt">💰 Debt</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Initial Balance</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">GHS</span>
                        <input type="number" id="accountBalance" step="0.01" placeholder="0.00" class="w-full pl-16 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <button onclick="addAccount()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold text-lg hover:shadow-lg transition-shadow mt-6">
                    Add Account
                </button>
            </div>
        </div>
    </div>

    <!-- Asset Modal -->
    <div id="assetModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-md w-full p-4 md:p-6 my-4 md:my-8">
            <div class="flex justify-between items-center mb-6">
                <h2 id="assetModalTitle" class="text-2xl font-bold text-gray-800">Add New Asset</h2>
                <button onclick="closeAssetModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Form Fields -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Asset Name</label>
                    <input type="text" id="assetName" placeholder="e.g., Toyota Camry, House, Gold Watch" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="assetCategory" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="real-estate">🏠 Real Estate</option>
                        <option value="vehicle">🚗 Vehicle</option>
                        <option value="investment">📈 Investment</option>
                        <option value="jewelry">💍 Jewelry</option>
                        <option value="loan">💰 Loan Given</option>
                        <option value="other">📦 Other</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Value</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">GHS</span>
                        <input type="number" id="assetValue" step="0.01" placeholder="0.00" class="w-full pl-16 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Date</label>
                    <input type="date" id="assetPurchaseDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                    <textarea id="assetDescription" rows="3" placeholder="Additional details about the asset..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                </div>

                <button id="assetSubmitBtn" onclick="addAsset()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold text-lg hover:shadow-lg transition-shadow mt-6">
                    Add Asset
                </button>
            </div>
        </div>
    </div>

    <!-- Liability Modal -->
    <div id="liabilityModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-md w-full p-4 md:p-6 my-4 md:my-8">
            <div class="flex justify-between items-center mb-6">
                <h2 id="liabilityModalTitle" class="text-2xl font-bold text-gray-800">Add New Liability</h2>
                <button onclick="closeLiabilityModal()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Form Fields -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Liability Name</label>
                    <input type="text" id="liabilityName" placeholder="e.g., Bank Loan, Credit Card, Friend Loan" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type</label>
                    <select id="liabilityType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <option value="bank-loan">🏦 Bank Loan</option>
                        <option value="credit-card">💳 Credit Card</option>
                        <option value="personal-loan">👥 Personal Loan</option>
                        <option value="mortgage">🏠 Mortgage</option>
                        <option value="other">📋 Other</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Balance</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">GHS</span>
                        <input type="number" id="liabilityAmount" step="0.01" placeholder="0.00" class="w-full pl-16 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Interest Rate (Optional)</label>
                    <div class="relative">
                        <input type="number" id="liabilityInterestRate" step="0.01" placeholder="0.00" class="w-full pr-8 pl-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">%</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                    <input type="date" id="liabilityStartDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Due Date (Optional)</label>
                    <input type="date" id="liabilityDueDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                    <textarea id="liabilityDescription" rows="3" placeholder="Additional details about the liability..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 resize-none"></textarea>
                </div>

                <button id="liabilitySubmitBtn" onclick="addLiability()" class="w-full bg-gradient-to-r from-red-600 to-pink-600 text-white py-4 rounded-xl font-semibold text-lg hover:shadow-lg transition-shadow mt-6">
                    Add Liability
                </button>
            </div>
        </div>
    </div>

    <div id="reminderModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-md w-full p-4 md:p-6 my-4 md:my-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Add Reminder</h2>
                <button onclick="closeReminderModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            <div class="space-y-3">
                <input type="text" id="reminderTitle" placeholder="Bill Name (e.g., Electricity, Rent)" class="w-full px-4 py-3 border rounded-lg">
                <input type="number" id="reminderAmount" step="0.01" placeholder="Expected Amount" class="w-full px-4 py-3 border rounded-lg">
                <input type="datetime-local" id="reminderDate" class="w-full px-4 py-3 border rounded-lg">
                <select id="reminderFrequency" class="w-full px-4 py-3 border rounded-lg">
                    <option value="once">One-time</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <button onclick="addReminder()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold">Add Reminder</button>
            </div>
        </div>
    </div>

    <!-- Liabilities Breakdown Modal -->
    <div id="liabilitiesBreakdownModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-2xl w-full p-4 md:p-6 my-4 md:my-8 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Liabilities Breakdown</h2>
                <button onclick="closeLiabilitiesBreakdown()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="breakdownContent" class="space-y-4">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-md w-full p-4 md:p-6 my-4 md:my-8 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Settings</h2>
                <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                    <select id="currencySelect" class="w-full px-4 py-3 border rounded-lg">
                        <option value="GHS">GHS - Ghanaian Cedi</option>
                        <option value="USD">USD - US Dollar</option>
                        <option value="EUR">EUR - Euro</option>
                        <option value="GBP">GBP - British Pound</option>
                        <option value="JPY">JPY - Japanese Yen</option>
                        <option value="CAD">CAD - Canadian Dollar</option>
                        <option value="AUD">AUD - Australian Dollar</option>
                    </select>
                </div>
                
                <!-- Email Notifications -->
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold mb-3">Email Notifications</h3>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                        <p class="text-sm text-blue-800">
                            <strong>📧 Daily Transaction Summaries</strong><br>
                            Receive email reports at 6 AM and 6 PM with all transactions made that day.
                        </p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="enableEmailNotifications" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" onchange="toggleEmailNotifications()">
                            <span class="ml-2 text-sm text-gray-700">Enable email notifications</span>
                        </label>
                    </div>
                    
                    <div id="emailNotificationSettings" class="hidden space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notification Email</label>
                            <input type="email" id="notificationEmail" placeholder="your.email@example.com" class="w-full px-4 py-3 border rounded-lg text-sm">
                            <p class="text-xs text-gray-500 mt-1">This email will receive transaction summaries</p>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <p class="text-xs text-yellow-800">
                                ⚠️ <strong>Setup Required:</strong> To use email notifications, you need to:
                                <ol class="list-decimal ml-4 mt-1">
                                    <li>Create a free account at <a href="https://www.emailjs.com" target="_blank" class="underline">EmailJS.com</a></li>
                                    <li>Get your Public Key, Service ID, and Template ID</li>
                                    <li>Enter them in the fields below</li>
                                </ol>
                            </p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">EmailJS Public Key</label>
                            <input type="text" id="emailjsPublicKey" placeholder="Your EmailJS Public Key" class="w-full px-4 py-3 border rounded-lg text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">EmailJS Service ID</label>
                            <input type="text" id="emailjsServiceId" placeholder="Your EmailJS Service ID" class="w-full px-4 py-3 border rounded-lg text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">EmailJS Template ID</label>
                            <input type="text" id="emailjsTemplateId" placeholder="Your EmailJS Template ID" class="w-full px-4 py-3 border rounded-lg text-sm">
                        </div>
                        
                        <button onclick="testEmailNotification()" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm hover:bg-blue-700">Send Test Email</button>
                    </div>
                </div>

                <!-- Category Management -->
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold mb-3">Category Management</h3>

                    <!-- Add Income Category -->
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Add Income Category</label>
                        <div class="flex gap-2">
                            <input type="text" id="newIncomeCategory" placeholder="e.g., Bonus, Side Hustle" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                            <button onclick="addCustomCategory('income')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700">Add</button>
                        </div>
                    </div>

                    <!-- Add Expense Category -->
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Add Expense Category</label>
                        <div class="flex gap-2">
                            <input type="text" id="newExpenseCategory" placeholder="e.g., Insurance, Subscription" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                            <button onclick="addCustomCategory('expense')" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">Add</button>
                        </div>
                    </div>

                    <!-- Current Categories -->
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Current Categories</label>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <h4 class="font-semibold text-green-600 mb-1">Income</h4>
                                <div id="incomeCategoriesList" class="space-y-1"></div>
                            </div>
                            <div>
                                <h4 class="font-semibold text-red-600 mb-1">Expense</h4>
                                <div id="expenseCategoriesList" class="space-y-1"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold mb-3 text-red-600">⚠️ Data Management</h3>
                    <p class="text-sm text-gray-600 mb-3">This will permanently delete all your transactions, budgets, accounts, and custom categories. This action cannot be undone.</p>
                    <button onclick="clearAllData()" class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700">🗑️ Clear All Data</button>
                </div>

                <button onclick="saveSettings()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // REPLACE THESE VALUES WITH YOUR OWN FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAocH0mqZA5iUXgq_BeTfGqV1cuUbWRntY",
    authDomain: "budget-tracker-91bcc.firebaseapp.com",
    databaseURL: "https://budget-tracker-91bcc-default-rtdb.firebaseio.com",
    projectId: "budget-tracker-91bcc",
    storageBucket: "budget-tracker-91bcc.firebasestorage.app",
    messagingSenderId: "657417341954",
    appId: "1:657417341954:web:08972dae3623bdd61f6b1b",
    measurementId: "G-BV3C6NY0B1"
        };
        
        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes('YOUR')) {
            console.warn('⚠️ Firebase config incomplete! Replace placeholder values in firebaseConfig.');
        }

        // Initialize Firebase
        let app, auth, db, currentUser = null;

        // ============================================
        // AUTO-LOGOUT FUNCTIONALITY
        // ============================================
        let autoLogoutTimer;
        const AUTO_LOGOUT_TIME = 5 * 60 * 1000; // 5 minutes in milliseconds

        function startAutoLogoutTimer() {
            clearAutoLogoutTimer(); // Clear any existing timer

            autoLogoutTimer = setTimeout(() => {
                console.log('Auto-logout: 5 minutes of inactivity detected');
                performAutoLogout();
            }, AUTO_LOGOUT_TIME);
        }

        function clearAutoLogoutTimer() {
            if (autoLogoutTimer) {
                clearTimeout(autoLogoutTimer);
                autoLogoutTimer = null;
            }
        }

        function resetAutoLogoutTimer() {
            if (currentUser) { // Only reset if user is logged in
                startAutoLogoutTimer();
            }
        }

        async function performAutoLogout() {
            console.log('Performing automatic logout due to inactivity');
            try {
                await auth.signOut();
                showAutoLogoutNotification();
            } catch (error) {
                console.error('Auto-logout failed:', error);
            }
        }

        function showAutoLogoutNotification() {
            // Create a notification banner
            const notification = document.createElement('div');
            notification.id = 'autoLogoutNotification';
            notification.className = 'fixed top-4 left-4 right-4 bg-orange-500 text-white p-4 rounded-lg shadow-lg z-50 md:left-auto md:right-4 md:w-96';
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold">Auto Logout</p>
                            <p class="text-sm opacity-90">You were logged out due to 5 minutes of inactivity</p>
                        </div>
                    </div>
                    <button onclick="dismissAutoLogoutNotification()" class="text-white opacity-75 hover:opacity-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                dismissAutoLogoutNotification();
            }, 5000);
        }

        function dismissAutoLogoutNotification() {
            const notification = document.getElementById('autoLogoutNotification');
            if (notification) {
                notification.remove();
            }
        }

        function setupActivityTracking() {
            // List of events that indicate user activity
            const activityEvents = [
                'mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'touchmove',
                'click', 'keydown', 'wheel', 'contextmenu'
            ];

            // Throttled activity handler to avoid excessive timer resets
            let activityTimeout;
            function handleActivity() {
                if (activityTimeout) return; // Throttle

                activityTimeout = setTimeout(() => {
                    resetAutoLogoutTimer();
                    activityTimeout = null;
                }, 100); // Reset timer at most every 100ms
            }

            // Add event listeners for all activity events
            activityEvents.forEach(event => {
                document.addEventListener(event, handleActivity, { passive: true });
            });

            // Also track visibility changes (tab switching)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && currentUser) {
                    resetAutoLogoutTimer();
                }
            });

            // Track window focus
            window.addEventListener('focus', () => {
                if (currentUser) {
                    resetAutoLogoutTimer();
                }
            });
        }

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('Firebase initialized successfully');
            document.getElementById('firebaseNotice').classList.add('hidden');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Firebase configuration needed. Please see setup instructions below.');
        }

        // ============================================
        // APP STATE
        // ============================================
        let transactions = [];
        let budgets = [];
        let accounts = [{id: 'default', name: 'Cash', type: 'cash', balance: 0}];
        let recurring = [];
        let reminders = [];
        let assets = [];
        let liabilities = [];
        let currentFilter = 'all';
        let currentType = 'expense';
        let currentTab = 'transactions';
        let currentAccount = 'default';
        let currency = 'GHS';
        let analyticsChart = null;
        
        // Email notification settings
        let emailNotifications = {
            enabled: false,
            email: '',
            emailjsPublicKey: '',
            emailjsServiceId: '',
            emailjsTemplateId: '',
            lastNotificationDate: null,
            pendingTransactions: []
        };

        const categories = {
            income: ['Salary', 'Freelance', 'Business', 'Investment', 'Gift', 'Loan Repayment', 'Other'],
            expense: ['Food', 'Transport', 'Shopping', 'Bills', 'Entertainment', 'Health', 'Education', 'Other']
        };

        // ============================================
        // AUTHENTICATION
        // ============================================
        auth.onAuthStateChanged(user => {
            // Add auth-ready class to body to show content
            document.body.classList.add('auth-ready');
            
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.remove('show-login');
                document.getElementById('mainApp').classList.add('show-app');
                document.getElementById('fabButton').classList.remove('hidden'); // Show FAB button
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('autoLogoutStatus').classList.remove('hidden');

                // Start auto-logout functionality
                setupActivityTracking();
                startAutoLogoutTimer();

                loadFirebaseData();
            } else {
                currentUser = null;
                document.getElementById('loginScreen').classList.add('show-login');
                document.getElementById('mainApp').classList.remove('show-app');
                document.getElementById('fabButton').classList.add('hidden'); // Hide FAB button
                document.getElementById('autoLogoutStatus').classList.add('hidden');

                // Ensure login form is shown and loading is hidden
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('authLoading').classList.add('hidden');

                // Stop auto-logout functionality
                clearAutoLogoutTimer();
            }
        });

        // Add Enter key listeners for login and register forms
        function setupFormListeners() {
            // Login form
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');
            if (loginEmail) {
                loginEmail.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loginUser();
                    }
                });
            }
            if (loginPassword) {
                loginPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loginUser();
                    }
                });
            }
            
            // Register form
            const registerEmail = document.getElementById('registerEmail');
            const registerPassword = document.getElementById('registerPassword');
            const registerPasswordConfirm = document.getElementById('registerPasswordConfirm');
            if (registerEmail) {
                registerEmail.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        registerUser();
                    }
                });
            }
            if (registerPassword) {
                registerPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        registerUser();
                    }
                });
            }
            if (registerPasswordConfirm) {
                registerPasswordConfirm.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        registerUser();
                    }
                });
            }
            
            // Forgot password form
            const forgotEmail = document.getElementById('forgotEmail');
            if (forgotEmail) {
                forgotEmail.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        resetPassword();
                    }
                });
            }
        }

        // Initialize form listeners when page loads
        setupFormListeners();

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
        }

        function showForgotPassword() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
            // Clear any previous messages
            document.getElementById('forgotError').classList.add('hidden');
            document.getElementById('forgotSuccess').classList.add('hidden');
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                errorEl.classList.remove('hidden');
                return;
            }

            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('authLoading').classList.remove('hidden');

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('authLoading').classList.add('hidden');
            }
        }

        async function resetPassword() {
            const email = document.getElementById('forgotEmail').value;
            const errorEl = document.getElementById('forgotError');
            const successEl = document.getElementById('forgotSuccess');

            if (!email) {
                errorEl.textContent = 'Please enter your email address';
                errorEl.classList.remove('hidden');
                successEl.classList.add('hidden');
                return;
            }

            // Clear previous messages
            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');

            // Show loading state
            document.getElementById('forgotPasswordForm').querySelector('button').textContent = 'Sending...';
            document.getElementById('forgotPasswordForm').querySelector('button').disabled = true;

            try {
                await auth.sendPasswordResetEmail(email);
                successEl.textContent = 'Password reset email sent! Check your inbox.';
                successEl.classList.remove('hidden');
                document.getElementById('forgotEmail').value = '';
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            } finally {
                // Reset button
                document.getElementById('forgotPasswordForm').querySelector('button').textContent = 'Send Reset Link';
                document.getElementById('forgotPasswordForm').querySelector('button').disabled = false;
            }
        }

        async function registerUser() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const errorEl = document.getElementById('registerError');

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password !== passwordConfirm) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('authLoading').classList.remove('hidden');

            try {
                await auth.createUserWithEmailAndPassword(email, password);
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                document.getElementById('authLoading').classList.add('hidden');
            }
        }

        async function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                // Show loading state
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.add('hidden');
                document.getElementById('authLoading').classList.remove('hidden');
                
                clearAutoLogoutTimer(); // Clear the auto-logout timer
                
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                    // If logout fails, show login form again
                    document.getElementById('loginForm').classList.remove('hidden');
                    document.getElementById('authLoading').classList.add('hidden');
                    alert('Logout failed. Please try again.');
                }
            }
        }

        // ============================================
        // FIREBASE DATA OPERATIONS
        // ============================================
        function setSyncStatus(message, isError = false) {
            const el = document.getElementById('syncStatus');
            el.innerHTML = `
                <div class="w-2 h-2 ${isError ? 'bg-red-400' : 'bg-green-400'} rounded-full"></div>
                <span>${message}</span>
            `;
        }

        async function loadFirebaseData() {
            if (!currentUser) return;
            
            setSyncStatus('Loading...');
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    transactions = data.transactions || [];
                    budgets = data.budgets || [];
                    accounts = data.accounts || [{id: 'default', name: 'Cash', type: 'cash', balance: 0}];
                    recurring = data.recurring || [];
                    reminders = data.reminders || [];
                    assets = data.assets || [];
                    liabilities = data.liabilities || [];
                    currency = data.currency || 'GHS';
                    
                    console.log('Loaded from Firebase, accounts:', accounts.length, accounts);
                    
                    // Save to localStorage as backup
                    localStorage.setItem('budgetTracker_backup', JSON.stringify({
                        transactions, budgets, accounts, recurring, reminders, assets, liabilities, currency
                    }));
                    
                    // Recalculate account balances based on transactions to ensure accuracy
                    recalculateAccountBalances();
                } else {
                    // No data in Firebase, try localStorage
                    console.log('No Firebase data, loading from localStorage');
                    loadFromLocalStorage();
                }
                
                init();
                setSyncStatus('Synced');
            } catch (error) {
                console.error('Load error:', error);
                setSyncStatus('Offline - using local data', true);
                // Load from localStorage as fallback
                loadFromLocalStorage();
                init();
            }
        }

        async function saveToFirebase() {
            console.log('saveToFirebase called, accounts:', accounts.length);
            if (!currentUser) {
                // Save to localStorage only
                console.log('No user, saving to localStorage only');
                localStorage.setItem('budgetTracker_backup', JSON.stringify({
                    transactions, budgets, accounts, recurring, reminders, assets, liabilities, currency
                }));
                return;
            }
            
            setSyncStatus('Syncing...');
            
            try {
                console.log('Saving to Firebase, accounts:', accounts);
                await db.collection('users').doc(currentUser.uid).set({
                    transactions,
                    budgets,
                    accounts,
                    recurring,
                    reminders,
                    assets,
                    liabilities,
                    currency,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Also save to localStorage as backup
                localStorage.setItem('budgetTracker_backup', JSON.stringify({
                    transactions, budgets, accounts, recurring, reminders, assets, liabilities, currency
                }));
                console.log('Saved to Firebase successfully');
                
                setSyncStatus('Synced');
            } catch (error) {
                console.error('Save error:', error);
                setSyncStatus('Sync failed - saved locally', true);
                // Save to localStorage as fallback
                localStorage.setItem('budgetTracker_backup', JSON.stringify({
                    transactions, budgets, accounts, recurring, reminders, assets, liabilities, currency
                }));
            }
        }

        function loadFromLocalStorage() {
            const backup = localStorage.getItem('budgetTracker_backup');
            console.log('loadFromLocalStorage called, backup exists:', !!backup);
            if (backup) {
                const data = JSON.parse(backup);
                transactions = data.transactions || [];
                budgets = data.budgets || [];
                accounts = data.accounts || [{id: 'default', name: 'Cash', type: 'cash', balance: 0}];
                recurring = data.recurring || [];
                reminders = data.reminders || [];
                assets = data.assets || [];
                liabilities = data.liabilities || [];
                currency = data.currency || 'GHS';
                
                console.log('Loaded from localStorage, accounts:', accounts.length, accounts);
                
                // Recalculate account balances
                recalculateAccountBalances();
            } else {
                // No backup, use defaults
                console.log('No localStorage backup, using defaults');
                accounts = [{id: 'default', name: 'Cash', type: 'cash', balance: 0}];
            }
        }

        async function clearAllData() {
        if (!currentUser) {
        alert('Please log in first');
        return;
        }

        const confirmDelete = confirm(
        '⚠️ WARNING: This will permanently delete ALL your data!\n\n' +
        'This includes:\n' +
        '• All transactions (income & expenses)\n' +
        '• All budgets and budget history\n' +
        '• All accounts and balances\n' +
        '• All recurring transactions\n' +
        '• All reminders\n' +
        '• All assets\n' +
        '• All liabilities\n' +
        '• All custom categories\n\n' +
        'This action CANNOT be undone!\n\n' +
        'Are you sure you want to continue?'
        );

        if (!confirmDelete) return;

        const finalConfirm = confirm('FINAL WARNING: This will delete EVERYTHING from both your device and the cloud. Are you absolutely sure?');
        if (!finalConfirm) return;

        try {
        setSyncStatus('Deleting data...');

        // Delete Firebase document
        await db.collection('users').doc(currentUser.uid).delete();

        // Clear localStorage
        localStorage.removeItem('budgetTracker_customCategories');
                    localStorage.removeItem('budgetTracker_backup');
        localStorage.removeItem('emailNotifications');

        // Reset all in-memory data to defaults
        transactions = [];
        budgets = [];
        accounts = [{id: 'default', name: 'Cash', type: 'cash', balance: 0}];
        recurring = [];
        reminders = [];
        assets = [];
                    liabilities = [];
        currency = 'GHS';
        emailNotifications = {
            enabled: false,
                        email: '',
            emailjsPublicKey: '',
            emailjsServiceId: '',
            emailjsTemplateId: '',
                        lastNotificationDate: null,
            pendingTransactions: []
        };

            // Save the empty state to Firebase
        await saveToFirebase();

        // Reinitialize the app
            init();
                updateCategoriesDisplay();

                    setSyncStatus('All data cleared');
                    
                    alert('✅ All data has been successfully deleted from both your device and the cloud!\n\nYou can now start fresh with new entries.');

                    // Close settings modal
                    closeSettingsModal();

                } catch (error) {
                    console.error('Clear data error:', error);
                    setSyncStatus('Error clearing data', true);
                    alert('❌ Error clearing data. Please try again.\n\nError: ' + error.message);
                }
            }

        function recalculateAccountBalances() {
            // Reset all account balances to 0
            accounts.forEach(account => {
                account.balance = 0;
            });

            // Reset budget spent
            budgets.forEach(budget => {
                budget.spent = 0;
            });

            // Recalculate balances based on transactions
            transactions.forEach(transaction => {
                if (transaction.type === 'transfer') {
                    // Handle transfers
                    const fromAccount = accounts.find(a => a.id === transaction.fromAccount);
                    const toAccount = accounts.find(a => a.id === transaction.toAccount);
                    const amount = Number(transaction.amount || 0);
                    
                    if (fromAccount) fromAccount.balance -= amount;
                    if (toAccount) toAccount.balance += amount;
                } else if (transaction.type === 'income') {
                    // Handle income
                    const account = accounts.find(a => a.id === transaction.account);
                    const amount = Number(transaction.amount || 0);
                    
                    if (account) account.balance += amount;
                } else if (transaction.type === 'expense') {
                    // Handle expense
                    const account = accounts.find(a => a.id === transaction.account);
                    const amount = Number(transaction.amount || 0);
                    
                    if (account) account.balance -= amount;
                    
                    // Update budget spent
                    updateBudgetSpent(transaction.category, amount);
                }
            });
        }

function reduceLoanAssets(repaymentAmount) {
                const loanAssets = assets.filter(asset => asset.category === 'loan' && asset.value > 0);
                if (loanAssets.length === 0) return;
                
                let totalLoanValue = loanAssets.reduce((sum, asset) => sum + Number(asset.value || 0), 0);
                if (totalLoanValue <= 0) return;
                
                // Distribute repayment proportionally across all loans
                let remainingRepayment = repaymentAmount;
                
                for (const asset of loanAssets) {
                    if (remainingRepayment <= 0) break;
                    
                    const assetValue = Number(asset.value || 0);
                    const proportion = assetValue / totalLoanValue;
                    const repaymentForThisAsset = Math.min(assetValue, repaymentAmount * proportion);
                    
                    asset.value = Math.max(0, assetValue - repaymentForThisAsset);
                    remainingRepayment -= repaymentForThisAsset;
                    
                    // If loan is fully repaid, we could optionally remove it or mark it as repaid
                    if (asset.value <= 0) {
                        // Keep the asset with value 0 to maintain history, or remove it
                        // For now, keep it with 0 value
                    }
                }
                
                // Save changes
                saveToFirebase();
                renderAssets();
        }

            function updateBudgetSpent(category, amount) {
                const budget = budgets.find(b => b.category === category);
                if (budget) {
                    budget.spent = Number(budget.spent || 0) + amount;
                }
            }
        function init() {
            // Set current date and time
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const dateTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('date').value = dateTimeString;
            
            updateCategories();
            updateAccountSelectors();
            renderTransactions();
            renderBudgets();
            renderAccounts();
            updateTotals();
            
            // Initialize filter button active state
            setFilter('all');
            
            // Initialize category display for settings modal
            updateCategoriesDisplay();
            
            // Initialize currency select
            const currencySelect = document.getElementById('currencySelect');
            if (currencySelect) currencySelect.value = currency;
            
            // Initialize analytics select event listener
            const analyticsSelect = document.getElementById('analyticsType');
            if (analyticsSelect) {
                analyticsSelect.addEventListener('change', updateAnalytics);
            }
            // Initialize current date
            const dateEl = document.getElementById('currentDate');
            if (dateEl) {
                const now = new Date();
                dateEl.textContent = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
            
            // Start email notification scheduler
            startEmailNotificationScheduler();
        }

        // ============================================
        // CORE FUNCTIONS (Same as before but with saveToFirebase())
        // ============================================
        function setType(type) {
            currentType = type;
            
            // Update button styles
            document.getElementById('typeIncome').className = type === 'income'
                ? 'p-4 rounded-2xl border-2 border-green-500 bg-green-50 text-green-700'
                : 'p-4 rounded-2xl border-2 border-gray-200 hover:border-green-300 transition-colors group';
            document.getElementById('typeExpense').className = type === 'expense'
                ? 'p-4 rounded-2xl border-2 border-red-500 bg-red-50 text-red-700'
                : 'p-4 rounded-2xl border-2 border-gray-200 hover:border-red-300 transition-colors group';
            document.getElementById('typeTransfer').className = type === 'transfer'
                ? 'p-4 rounded-2xl border-2 border-blue-500 bg-blue-50 text-blue-700'
                : 'p-4 rounded-2xl border-2 border-gray-200 hover:border-blue-300 transition-colors group';
            
            // Show/hide fields based on type
            const categoryField = document.getElementById('category').parentElement;
            const accountField = document.getElementById('accountField');
            const transferFields = document.getElementById('transferFields');
            
            if (type === 'transfer') {
                categoryField.style.display = 'none';
                accountField.classList.add('hidden');
                transferFields.classList.remove('hidden');
            } else {
                categoryField.style.display = 'block';
                accountField.classList.remove('hidden');
                transferFields.classList.add('hidden');
            }
            
            updateCategories();
        }

        function updateCategories() {
            const select = document.getElementById('category');
            const budgetSelect = document.getElementById('budgetCategory');

            // Load custom categories
            const customCategories = loadCustomCategories();

            select.innerHTML = '<option value="">Select category</option>';
            budgetSelect.innerHTML = '<option value="">Select category</option>';

            // Add default categories if currentType is not transfer
            if (currentType !== 'transfer' && categories[currentType]) {
                categories[currentType].forEach(cat => {
                    select.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
            }

            // Add custom categories if currentType is not transfer
            if (currentType !== 'transfer' && customCategories[currentType]) {
                customCategories[currentType].forEach(cat => {
                    select.innerHTML += `<option value="${cat}">${cat} ⭐</option>`;
                });
            }

            // Add expense categories for budget select
            categories.expense.forEach(cat => {
                budgetSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });

            // Add custom expense categories for budget select
            customCategories.expense.forEach(cat => {
                budgetSelect.innerHTML += `<option value="${cat}">${cat} ⭐</option>`;
            });
        }
        function updateAccountSelectors() {
            const selectors = ['accountSelect', 'accountSelector', 'fromAccountSelect', 'toAccountSelect'];
            selectors.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const current = el.value || 'default';
                el.innerHTML = '';
                accounts.forEach(acc => {
                    el.innerHTML += `<option value="${acc.id}">${acc.name}</option>`;
                });
                try { el.value = current; } catch (e) { /* ignore */ }
            });
        }

            // Minimal safe stubs so the page can initialize without throwing
            function renderReminders() {
                const el = document.getElementById('remindersList');
                if (!el) return;

                if (!reminders || reminders.length === 0) {
                    el.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-gray-500 text-lg">No reminders yet</p>
                            <p class="text-gray-400 text-sm">Add your first bill reminder to get started</p>
                        </div>
                    `;
                    return;
                }

                el.innerHTML = reminders.map(reminder => {
                    const reminderDate = new Date(reminder.date);
                    const today = new Date();
                    const daysUntil = Math.ceil((reminderDate - today) / (1000 * 60 * 60 * 24));
                    
                    let statusColor = 'bg-green-100 text-green-800';
                    let statusText = 'Upcoming';
                    
                    if (daysUntil < 0) {
                        statusColor = 'bg-red-100 text-red-800';
                        statusText = 'Overdue';
                    } else if (daysUntil <= 3) {
                        statusColor = 'bg-yellow-100 text-yellow-800';
                        statusText = 'Due Soon';
                    }
                    
                    // Format date and time
                    const formatDateTime = (dateString) => {
                        if (!dateString) return '';
                        const date = new Date(dateString);
                        const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
                        const timeOptions = { hour: '2-digit', minute: '2-digit' };
                        return `${date.toLocaleDateString('en-US', dateOptions)} at ${date.toLocaleTimeString('en-US', timeOptions)}`;
                    };

                    return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">${reminder.title}</p>
                                        <p class="text-sm text-gray-500 capitalize">${reminder.frequency} • ${formatDateTime(reminder.date)}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg text-gray-900">${currency}${Number(reminder.amount || 0).toFixed(2)}</p>
                                    <span class="inline-block px-2 py-1 text-xs rounded-full ${statusColor} mt-1">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function renderTransactions() {
                const el = document.getElementById('transactionsList');
                if (!el) return;
                if (!transactions || transactions.length === 0) {
                    el.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            <p class="text-gray-500 text-lg">No transactions yet</p>
                            <p class="text-gray-400 text-sm">Add your first transaction to get started</p>
                        </div>
                    `;
                    return;
                }

                // Filter transactions based on current filter
                let filteredTransactions = transactions;
                if (currentFilter === 'income') {
                    filteredTransactions = transactions.filter(t => t.type === 'income');
                } else if (currentFilter === 'expense') {
                    filteredTransactions = transactions.filter(t => t.type === 'expense');
                } else if (currentFilter === 'transfer') {
                    filteredTransactions = transactions.filter(t => t.type === 'transfer');
                }

                // Apply search filter
                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                
                if (searchTerm || dateFrom || dateTo) {
                    filteredTransactions = filteredTransactions.filter(t => {
                        // Text search
                        let matchesSearch = true;
                        if (searchTerm) {
                            const description = (t.description || '').toLowerCase();
                            const category = (t.category || '').toLowerCase();
                            const amount = (t.amount || '').toString();
                            const accountName = t.account ? (accounts.find(a => a.id === t.account)?.name || '').toLowerCase() : '';
                            const fromAccountName = t.fromAccount ? (accounts.find(a => a.id === t.fromAccount)?.name || '').toLowerCase() : '';
                            const toAccountName = t.toAccount ? (accounts.find(a => a.id === t.toAccount)?.name || '').toLowerCase() : '';
                            
                            matchesSearch = description.includes(searchTerm) || 
                                           category.includes(searchTerm) || 
                                           amount.includes(searchTerm) ||
                                           accountName.includes(searchTerm) ||
                                           fromAccountName.includes(searchTerm) ||
                                           toAccountName.includes(searchTerm);
                        }
                        
                        // Date range filter
                        let matchesDate = true;
                        if (dateFrom || dateTo) {
                            const transactionDate = new Date(t.date);
                            if (dateFrom) {
                                const fromDate = new Date(dateFrom);
                                matchesDate = matchesDate && transactionDate >= fromDate;
                            }
                            if (dateTo) {
                                const toDate = new Date(dateTo);
                                toDate.setHours(23, 59, 59, 999); // Include the entire day
                                matchesDate = matchesDate && transactionDate <= toDate;
                            }
                        }
                        
                        return matchesSearch && matchesDate;
                    });
                }

                // Sort by date (newest first)
                filteredTransactions.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

                el.innerHTML = filteredTransactions.map(t => {
                    // Format date and time
                    const formatDateTime = (dateString) => {
                        if (!dateString) return '';
                        const date = new Date(dateString);
                        const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
                        const timeOptions = { hour: '2-digit', minute: '2-digit' };
                        return `${date.toLocaleDateString('en-US', dateOptions)} at ${date.toLocaleTimeString('en-US', timeOptions)}`;
                    };
                    
                    if (t.type === 'transfer') {
                        // Display transfer transactions differently
                        const fromAccountName = accounts.find(a => a.id === t.fromAccount)?.name || 'Unknown';
                        const toAccountName = accounts.find(a => a.id === t.toAccount)?.name || 'Unknown';
                        
                        return `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900">${t.description || 'Transfer'}</p>
                                            <p class="text-sm text-gray-500">${fromAccountName} → ${toAccountName} • ${formatDateTime(t.date)}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-lg text-blue-600">${currency}${Number(t.amount || 0).toFixed(2)}</p>
                                        <p class="text-xs text-gray-500">Transfer</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Regular income/expense transaction
                        const isIncome = t.type === 'income';
                        const amountColor = isIncome ? 'text-green-600' : 'text-red-600';
                        const bgColor = isIncome ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                        const iconColor = isIncome ? 'text-green-500' : 'text-red-500';

                        return `
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 ${bgColor} rounded-full flex items-center justify-center">
                                            <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                ${isIncome ?
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>' :
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>'
                                                }
                                            </svg>
                                        </div>
                                        <div>
                                        <p class="font-medium text-gray-900">${t.description || t.category || 'Transaction'}</p>
                                        <p class="text-sm text-gray-500">${t.category || ''} • ${formatDateTime(t.date)}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-lg ${amountColor}">${isIncome ? '+' : '-'}${currency}${Number(t.amount || 0).toFixed(2)}</p>
                                        <p class="text-xs text-gray-500">${t.account ? accounts.find(a => a.id === t.account)?.name || 'Account' : 'Cash'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }

            function renderBudgets() {
                const el = document.getElementById('budgetsList');
                if (!el) return;
                if (!budgets || budgets.length === 0) {
                    el.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 0v6m0-6l-6 6m6-6l6 6m-6-6v12"></path>
                            </svg>
                            <p class="text-gray-500 text-lg">No budgets set</p>
                            <p class="text-gray-400 text-sm">Create budgets to track your spending limits</p>
                        </div>
                    `;
                    return;
                }

                el.innerHTML = budgets.map(budget => {
                    const spent = budget.spent || 0;
                    const remaining = budget.amount - spent;
                    const percentage = budget.amount > 0 ? (spent / budget.amount) * 100 : 0;
                    const isOverBudget = spent > budget.amount;
                    const progressColor = isOverBudget ? 'bg-red-500' : percentage > 80 ? 'bg-yellow-500' : 'bg-green-500';

                    return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-gray-900">${budget.category}</h3>
                                <span class="text-sm text-gray-500 capitalize">${budget.period}</span>
                            </div>
                            <div class="mb-2">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Spent: ${currency}${spent.toFixed(2)}</span>
                                    <span>Budget: ${currency}${budget.amount.toFixed(2)}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${progressColor} h-2 rounded-full transition-all duration-300" style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm ${remaining >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${remaining >= 0 ? 'Remaining' : 'Over'}: ${currency}${Math.abs(remaining).toFixed(2)}
                                </span>
                                <button onclick="deleteBudget('${budget.category}')" class="text-red-500 hover:text-red-700 text-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function updateTotals() {
                let income = 0, expense = 0;
                (transactions || []).forEach(t => {
                    const amt = Number(t.amount || 0);
                    if (t.type === 'income') income += amt;
                    else if (t.type === 'expense') expense += amt;
                    // Transfers are not counted in income/expense totals
                });
                const incomeEl = document.getElementById('totalIncome');
                const expenseEl = document.getElementById('totalExpense');
                const balanceEl = document.getElementById('balance');
                const budgetEl = document.getElementById('budgetLeft');
                if (incomeEl) incomeEl.textContent = currency + income.toFixed(2);
                if (expenseEl) expenseEl.textContent = currency + expense.toFixed(2);
                if (balanceEl) balanceEl.textContent = currency + (income - expense).toFixed(2);
                if (budgetEl) budgetEl.textContent = currency + '0.00';

                // Update financial position
                updateFinancialPosition();
            }

            function updateFinancialPosition() {
                const incomeSourcesEl = document.getElementById('incomeSourcesList');
                const liabilitiesEl = document.getElementById('liabilitiesList');
                const totalAssetsEl = document.getElementById('totalAssetsValue');
                const totalLiabilitiesEl = document.getElementById('totalLiabilitiesValue');
                const netWorthEl = document.getElementById('netWorthValue');

                if (!incomeSourcesEl || !liabilitiesEl) return;

                let totalAssets = 0;
                let totalLiabilities = 0;

                // Income Sources: Accounts with positive balances + Assets
                const incomeSources = [];
                const liabilityItems = [];

                // Add account balances
                (accounts || []).forEach(account => {
                    const balance = Number(account.balance || 0);
                    const accountType = account.type || 'cash';

                    if (balance > 0) {
                        // Positive balance = Asset/Inco Source
                        incomeSources.push({
                            name: account.name,
                            type: accountType,
                            amount: balance,
                            category: 'account'
                        });
                        totalAssets += balance;
                    } else if (balance < 0) {
                        // Negative balance = Liability
                        liabilityItems.push({
                            name: account.name,
                            type: accountType,
                            amount: Math.abs(balance),
                            category: 'account'
                        });
                        totalLiabilities += Math.abs(balance);
                    }
                });

                // Add assets
                (assets || []).forEach(asset => {
                    const value = Number(asset.value || 0);
                    if (value > 0) {
                        incomeSources.push({
                            name: asset.name,
                            type: asset.category || 'asset',
                            amount: value,
                            category: 'asset'
                        });
                        totalAssets += value;
                    }
                });

                // Add dedicated liabilities
                (liabilities || []).forEach(liability => {
                    const amount = Number(liability.amount || 0);
                    if (amount > 0) {
                        liabilityItems.push({
                            name: liability.name,
                            type: liability.type || 'liability',
                            amount: amount,
                            category: 'liability'
                        });
                        totalLiabilities += amount;
                    }
                });

                // Sort by amount (highest first)
                incomeSources.sort((a, b) => b.amount - a.amount);
                liabilityItems.sort((a, b) => b.amount - a.amount);

                // Get type icons and colors
                const getTypeInfo = (type, category) => {
                    if (category === 'asset') {
                        const assetIcons = {
                            'real-estate': { icon: '🏠', color: 'text-green-600' },
                            'investment': { icon: '📈', color: 'text-purple-600' },
                            'vehicle': { icon: '🚗', color: 'text-blue-600' },
                            'jewelry': { icon: '💍', color: 'text-yellow-600' },
                            'loan': { icon: '💰', color: 'text-orange-600' },
                            'other': { icon: '💰', color: 'text-gray-600' }
                        };
                        return assetIcons[type] || assetIcons['other'];
                    } else if (category === 'liability') {
                        const liabilityIcons = {
                            'bank-loan': { icon: '🏦', color: 'text-blue-600' },
                            'credit-card': { icon: '💳', color: 'text-red-600' },
                            'personal-loan': { icon: '👥', color: 'text-green-600' },
                            'mortgage': { icon: '🏠', color: 'text-purple-600' },
                            'other': { icon: '💰', color: 'text-gray-600' }
                        };
                        return liabilityIcons[type] || liabilityIcons['other'];
                    } else {
                        const accountIcons = {
                            'cash': { icon: '💵', color: 'text-green-600' },
                            'bank': { icon: '🏦', color: 'text-blue-600' },
                            'credit': { icon: '💳', color: 'text-red-600' },
                            'mtn-momo': { icon: '📱', color: 'text-yellow-600' },
                            'telecel-cash': { icon: '📞', color: 'text-purple-600' },
                            'investment': { icon: '📈', color: 'text-indigo-600' },
                            'asset': { icon: '🏠', color: 'text-teal-600' },
                            'debt': { icon: '💰', color: 'text-orange-600' }
                        };
                        return accountIcons[type] || accountIcons['cash'];
                    }
                };

                // Render income sources
                incomeSourcesEl.innerHTML = incomeSources.length > 0 ?
                    incomeSources.map(source => {
                        const typeInfo = getTypeInfo(source.type, source.category);
                        return `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="text-lg">${typeInfo.icon}</span>
                                    <div>
                                        <p class="font-medium text-gray-900">${source.name}</p>
                                        <p class="text-sm text-gray-500 capitalize">${source.type.replace('-', ' ')}</p>
                                    </div>
                                </div>
                                <span class="font-semibold text-gray-900">${currency}${source.amount.toFixed(2)}</span>
                            </div>
                        `;
                    }).join('') :
                    '<p class="text-gray-500 text-center py-4">No income sources yet</p>';

                // Render liabilities
                liabilitiesEl.innerHTML = liabilityItems.length > 0 ?
                    liabilityItems.map(liability => {
                        const typeInfo = getTypeInfo(liability.type, liability.category);
                        return `
                            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <span class="text-lg">${typeInfo.icon}</span>
                                    <div>
                                        <p class="font-medium text-gray-900">${liability.name}</p>
                                        <p class="text-sm text-gray-500 capitalize">${liability.type.replace('-', ' ')}</p>
                                    </div>
                                </div>
                                <span class="font-semibold text-red-600">${currency}${liability.amount.toFixed(2)}</span>
                            </div>
                        `;
                    }).join('') :
                    '<p class="text-gray-500 text-center py-4">No liabilities</p>';

                // Update totals
                if (totalAssetsEl) totalAssetsEl.textContent = currency + totalAssets.toFixed(2);
                if (totalLiabilitiesEl) totalLiabilitiesEl.textContent = currency + totalLiabilities.toFixed(2);

                // Calculate and display net worth
                const netWorth = totalAssets - totalLiabilities;
                if (netWorthEl) {
                    netWorthEl.textContent = currency + netWorth.toFixed(2);
                    netWorthEl.className = netWorth >= 0 ? 'text-3xl font-bold text-green-400' : 'text-3xl font-bold text-red-400';
                }
            }

            // Lightweight helpers used by UI; full implementations can be restored later
            function switchTab(tab) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

                // Show selected tab content
                const target = document.getElementById('content' + tab.charAt(0).toUpperCase() + tab.slice(1));
                if (target) target.classList.remove('hidden');

                // Render content for specific tabs
                if (tab === 'accounts') {
                    renderAccounts();
                } else if (tab === 'assets') {
                    renderAssets();
                } else if (tab === 'liabilities') {
                    renderLiabilities();
                } else if (tab === 'reminders') {
                    renderReminders();
                } else if (tab === 'analytics') {
                    renderAnalytics();
                }

                // Update tab button styles
                document.querySelectorAll('[id^="tab"]').forEach(btn => {
                    if (btn.id === 'tab' + tab.charAt(0).toUpperCase() + tab.slice(1)) {
                        btn.classList.add('tab-active');
                        btn.classList.remove('text-gray-600');
                    } else {
                        btn.classList.remove('tab-active');
                        btn.classList.add('text-gray-600');
                    }
                });

                currentTab = tab;
            }

            function switchAccount() {
                currentAccount = document.getElementById('accountSelector').value;
                renderTransactions();
                updateTotals();
            }

            function openTransactionModal() { document.getElementById('transactionModal').classList.remove('hidden'); }
            function closeTransactionModal() { document.getElementById('transactionModal').classList.add('hidden'); }
            function openBudgetModal() { 
                document.getElementById('budgetModal').classList.remove('hidden');
                // Clear form fields when opening
                document.getElementById('budgetCategory').value = '';
                document.getElementById('budgetAmount').value = '';
                document.getElementById('budgetPeriod').value = 'monthly';
            }
            function closeBudgetModal() { document.getElementById('budgetModal').classList.add('hidden'); }

            function addBudget() {
                const category = document.getElementById('budgetCategory').value;
                const amount = parseFloat(document.getElementById('budgetAmount').value);
                const period = document.getElementById('budgetPeriod').value;
                if (!category || isNaN(amount) || amount <= 0) {
                    alert('Please enter valid category and amount');
                    return;
                }
                budgets.push({ category, amount, period, spent: 0 });
                saveToFirebase();
                closeBudgetModal();
                // Clear form fields
                document.getElementById('budgetCategory').value = '';
                document.getElementById('budgetAmount').value = '';
                document.getElementById('budgetPeriod').value = 'monthly';
                renderBudgets();
            }

            function deleteBudget(category) {
                if (confirm('Are you sure you want to delete this budget?')) {
                    budgets = budgets.filter(b => b.category !== category);
                    saveToFirebase();
                    renderBudgets();
                }
            }

            function addTransaction() {
                const amount = parseFloat(document.getElementById('amount').value);
                const date = document.getElementById('date').value;
                const description = document.getElementById('description').value;
                
                if (isNaN(amount) || amount <= 0 || !date) {
                    alert('Please enter valid amount and date');
                    return;
                }

                if (currentType === 'transfer') {
                    // Handle transfer between accounts
                    const fromAccount = document.getElementById('fromAccountSelect').value;
                    const toAccount = document.getElementById('toAccountSelect').value;
                    
                    if (!fromAccount || !toAccount) {
                        alert('Please select both from and to accounts');
                        return;
                    }
                    
                    if (fromAccount === toAccount) {
                        alert('Cannot transfer to the same account');
                        return;
                    }

                    // Create transfer transaction (expense from source, income to destination)
                    const transferDesc = description || `Transfer from ${accounts.find(a => a.id === fromAccount)?.name || 'Account'} to ${accounts.find(a => a.id === toAccount)?.name || 'Account'}`;
                    
                    transactions.push({
                        type: 'transfer',
                        amount,
                        fromAccount,
                        toAccount,
                        date,
                        description: transferDesc,
                        id: Date.now().toString() + Math.random().toString(36).slice(2)
                    });
                    
                    // Update account balances
                    const fromAcc = accounts.find(a => a.id === fromAccount);
                    const toAcc = accounts.find(a => a.id === toAccount);
                    if (fromAcc) fromAcc.balance -= amount;
                    if (toAcc) toAcc.balance += amount;
                    
                } else {
                    // Handle regular income/expense
                    const category = document.getElementById('category').value;
                    const account = document.getElementById('accountSelect').value;
                    
                    if (!category || !account) {
                        alert('Please fill in required fields');
                        return;
                    }
                    
                    transactions.push({
                        type: currentType,
                        amount,
                        category,
                        account,
                        date,
                        description,
                        id: Date.now().toString() + Math.random().toString(36).slice(2)
                    });
                    
                    // Update account balance
                    const selectedAccount = accounts.find(a => a.id === account);
                    if (selectedAccount) {
                        if (currentType === 'income') {
                            selectedAccount.balance = Number(selectedAccount.balance || 0) + amount;
                            
                            // If this is a loan repayment, reduce loan assets
                            if (category === 'Loan Repayment') {
                                reduceLoanAssets(amount);
                            }
                        } else if (currentType === 'expense') {
                            selectedAccount.balance = Number(selectedAccount.balance || 0) - amount;
                            // Update budget spent
                            updateBudgetSpent(category, amount);
                        }
                    }
                }
                
                // Record transaction for email notification
                recordTransactionForEmail(transactions[transactions.length - 1]);
                
                saveToFirebase();
                closeTransactionModal();
                renderTransactions();
                updateTotals();
                renderAccounts();
                renderBudgets();
                alert('Transaction added successfully!');
            }

            function setFilter(filter, event) {
                // Add pop animation to clicked button (only if event is provided)
                if (event && event.target) {
                    const clickedButton = event.target;
                    clickedButton.classList.add('filter-btn-pop');
                    setTimeout(() => {
                        clickedButton.classList.remove('filter-btn-pop');
                    }, 300);
                }
                
                // Update current filter
                currentFilter = filter;
                
                // Update button active states
                const buttons = ['filterAll', 'filterIncome', 'filterExpense', 'filterTransfer'];
                buttons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        // Remove all active classes
                        btn.classList.remove('filter-btn-active', 'filter-all', 'filter-income', 'filter-expense', 'filter-transfer');
                        
                        // Add active class based on current filter
                        if ((btnId === 'filterAll' && filter === 'all') ||
                            (btnId === 'filterIncome' && filter === 'income') ||
                            (btnId === 'filterExpense' && filter === 'expense') ||
                            (btnId === 'filterTransfer' && filter === 'transfer')) {
                            btn.classList.add('filter-btn-active', `filter-${filter}`);
                        }
                    }
                });
                
                renderTransactions();
            }

            function handleSearch() {
                renderTransactions();
            }

            function initializeFilterButtons() {
                // Set initial active state for 'all' filter without animation
                const filterAllBtn = document.getElementById('filterAll');
                if (filterAllBtn) {
                    filterAllBtn.classList.add('filter-btn-active', 'filter-all');
                }
            }

            function updateExportFormatOptions() {
                const exportType = document.getElementById('exportType').value;
                const formatSelect = document.getElementById('exportFormat');
                
                if (exportType === 'all') {
                    formatSelect.innerHTML = '<option value="json">JSON (Backup)</option>';
                } else {
                    formatSelect.innerHTML = `
                        <option value="csv">CSV (Spreadsheet)</option>
                        <option value="json">JSON (Backup)</option>
                    `;
                }
            }

            function exportData() {
                // Create export modal
                const modal = document.createElement('div');
                modal.id = 'exportModal';
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">Export Data</h2>
                            <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600">✕</button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">What to export:</label>
                                <select id="exportType" onchange="updateExportFormatOptions()" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="transactions">Transactions</option>
                                    <option value="accounts">Accounts & Assets</option>
                                    <option value="budgets">Budgets</option>
                                    <option value="reminders">Reminders</option>
                                    <option value="all">All Data (JSON)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Export format:</label>
                                <select id="exportFormat" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="csv">CSV (Spreadsheet)</option>
                                    <option value="json">JSON (Backup)</option>
                                </select>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="performExport()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 transition-colors">
                                    Export Data
                                </button>
                                <button onclick="closeExportModal()" class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                updateExportFormatOptions(); // Initialize format options
            }

            function closeExportModal() {
                const modal = document.getElementById('exportModal');
                if (modal) modal.remove();
            }

            function performExport() {
                const exportType = document.getElementById('exportType').value;
                const exportFormat = document.getElementById('exportFormat').value;

                let data;
                let filename;

                switch (exportType) {
                    case 'transactions':
                        data = transactions;
                        filename = `budget-transactions-${new Date().toISOString().split('T')[0]}`;
                        break;
                    case 'accounts':
                        data = [...accounts, ...assets.map(asset => ({ ...asset, type: 'asset', category: asset.category }))];
                        filename = `budget-accounts-assets-${new Date().toISOString().split('T')[0]}`;
                        break;
                    case 'budgets':
                        data = budgets;
                        filename = `budget-budgets-${new Date().toISOString().split('T')[0]}`;
                        break;
                    case 'reminders':
                        data = reminders;
                        filename = `budget-reminders-${new Date().toISOString().split('T')[0]}`;
                        break;
                    case 'all':
                        data = {
                            transactions,
                            accounts,
                            assets,
                            budgets,
                            reminders,
                            currency,
                            exportDate: new Date().toISOString(),
                            version: '1.0'
                        };
                        filename = `budget-backup-${new Date().toISOString().split('T')[0]}`;
                        break;
                }

                if (exportFormat === 'csv') {
                    exportToCSV(data, filename, exportType);
                } else {
                    exportToJSON(data, filename);
                }

                closeExportModal();
            }

            function exportToCSV(data, filename, type) {
                if (!Array.isArray(data)) {
                    // Handle non-array data (like 'all' export)
                    if (type === 'all') {
                        // For 'all' export, create separate CSV files or combine
                        alert('For complete backup, please use JSON format. CSV format is for individual data types.');
                        return;
                    }
                    alert('CSV export is only available for list data (transactions, accounts, etc.)');
                    return;
                }

                if (data.length === 0) {
                    alert('No data to export');
                    return;
                }

                // Get all unique keys from the data
                const headers = new Set();
                data.forEach(item => {
                    Object.keys(item).forEach(key => headers.add(key));
                });

                const headerArray = Array.from(headers);

                // Create CSV content
                let csvContent = headerArray.join(',') + '\n';

                data.forEach(item => {
                    const row = headerArray.map(header => {
                        const value = item[header];
                        if (value === null || value === undefined) return '';
                        if (typeof value === 'object') return JSON.stringify(value);
                        // Escape commas and quotes in CSV
                        const stringValue = String(value);
                        if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                            return '"' + stringValue.replace(/"/g, '""') + '"';
                        }
                        return stringValue;
                    });
                    csvContent += row.join(',') + '\n';
                });

                // Download the file
                downloadFile(csvContent, filename + '.csv', 'text/csv');
            }

            function exportToJSON(data, filename) {
                const jsonContent = JSON.stringify(data, null, 2);
                downloadFile(jsonContent, filename + '.json', 'application/json');
            }

            function downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Clean up the URL object
                setTimeout(() => URL.revokeObjectURL(url), 100);

                // Show success message
                showExportSuccess(filename);
            }

            function showExportSuccess(filename) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
                notification.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="font-semibold">Export Complete</p>
                            <p class="text-sm opacity-90">${filename} downloaded</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);

                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }

            function openRecurringModal() { /* stub */ }
            function closeRecurringModal() { /* stub */ }
            function openAccountModal() { 
                document.getElementById('accountModal').classList.remove('hidden'); 
                // Clear form
                document.getElementById('accountName').value = '';
                document.getElementById('accountType').value = 'cash';
                document.getElementById('accountBalance').value = '';
            }
            function closeAccountModal() { 
                document.getElementById('accountModal').classList.add('hidden'); 
            }
            function openReminderModal() { 
                document.getElementById('reminderModal').classList.remove('hidden');
                // Clear form
                document.getElementById('reminderTitle').value = '';
                document.getElementById('reminderAmount').value = '';
                document.getElementById('reminderDate').value = '';
                document.getElementById('reminderFrequency').value = 'monthly';
            }
            function closeReminderModal() { 
                document.getElementById('reminderModal').classList.add('hidden'); 
            }
            function addAccount() { 
                const name = document.getElementById('accountName').value.trim();
                const type = document.getElementById('accountType').value;
                const balance = parseFloat(document.getElementById('accountBalance').value) || 0;

                if (!name) {
                    alert('Please enter an account name');
                    return;
                }

                // Check if account name already exists
                if (accounts.some(acc => acc.name.toLowerCase() === name.toLowerCase())) {
                    alert('An account with this name already exists');
                    return;
                }

                const newAccount = {
                    id: Date.now().toString() + Math.random().toString(36).slice(2),
                    name: name,
                    type: type,
                    balance: 0,
                    archived: false
                };

                accounts.push(newAccount);
                
                // If initial balance is provided, create a transaction to persist it through recalculation
                if (balance !== 0) {
                    transactions.unshift({
                        type: balance > 0 ? 'income' : 'expense',
                        amount: Math.abs(balance),
                        account: newAccount.id,
                        date: new Date().toISOString().slice(0, 10),
                        description: 'Initial balance',
                        id: Date.now().toString() + Math.random().toString(36).slice(2),
                        isInitial: true
                    });
                }
                
                console.log('Account added:', newAccount);
                console.log('Total accounts:', accounts.length);
                saveToFirebase();
                closeAccountModal();
                updateAccountSelectors();
                renderAccounts();
                updateFinancialPosition();
                alert('Account added successfully!');
            }
            function addReminder() { 
                const title = document.getElementById('reminderTitle').value.trim();
                const amount = parseFloat(document.getElementById('reminderAmount').value);
                const date = document.getElementById('reminderDate').value;
                const frequency = document.getElementById('reminderFrequency').value;

                if (!title || !date) {
                    alert('Please enter title and date');
                    return;
                }

                const newReminder = {
                    id: Date.now().toString(),
                    title,
                    amount: amount || 0,
                    date,
                    frequency,
                    createdAt: new Date().toISOString()
                };

                reminders.push(newReminder);
                saveToFirebase();
                closeReminderModal();
                renderReminders();
                alert('Reminder added successfully!');
            }

            function openSettingsModal() {
                document.getElementById('settingsModal').classList.remove('hidden');
                // Set current currency in the select
                const currencySelect = document.getElementById('currencySelect');
                currencySelect.value = currency;
                // Load and display categories
                updateCategoriesDisplay();
                // Load email settings
                loadEmailSettings();
            }

            function closeSettingsModal() {
                document.getElementById('settingsModal').classList.add('hidden');
            }

            function saveSettings() {
                const newCurrency = document.getElementById('currencySelect').value;
                currency = newCurrency;
                
                // Save email settings
                saveEmailSettings();
                
                // Update all displays
                updateTotals();
                renderTransactions();
                // Save to Firebase
                saveToFirebase();
                closeSettingsModal();
                alert('Settings saved successfully!');
            }

            // ============================================
            // CATEGORY MANAGEMENT
            // ============================================

            // Load custom categories from localStorage
            function loadCustomCategories() {
                const saved = localStorage.getItem('budgetTracker_customCategories');
                return saved ? JSON.parse(saved) : { income: [], expense: [] };
            }

            // Save custom categories to localStorage
            function saveCustomCategories(customCategories) {
                localStorage.setItem('budgetTracker_customCategories', JSON.stringify(customCategories));
            }

            // Add a new custom category
            function addCustomCategory(type) {
                const inputId = type === 'income' ? 'newIncomeCategory' : 'newExpenseCategory';
                const categoryName = document.getElementById(inputId).value.trim();

                if (!categoryName) {
                    alert('Please enter a category name');
                    return;
                }

                // Check if category already exists
                const customCategories = loadCustomCategories();
                const allCategories = [...categories[type], ...customCategories[type]];

                if (allCategories.includes(categoryName)) {
                    alert('This category already exists');
                    return;
                }

                // Add the new category
                customCategories[type].push(categoryName);
                saveCustomCategories(customCategories);

                // Clear input and refresh display
                document.getElementById(inputId).value = '';
                updateCategoriesDisplay();
                updateCategories(); // Update dropdowns

                alert(`"${categoryName}" added to ${type} categories!`);
            }

            // Remove a custom category
            function removeCustomCategory(type, categoryName) {
                if (!confirm(`Are you sure you want to remove "${categoryName}"? This won't affect existing transactions.`)) {
                    return;
                }

                const customCategories = loadCustomCategories();
                customCategories[type] = customCategories[type].filter(cat => cat !== categoryName);
                saveCustomCategories(customCategories);

                updateCategoriesDisplay();
                updateCategories(); // Update dropdowns

                alert(`"${categoryName}" removed from ${type} categories!`);
            }

            // Update the categories display in settings modal
            function updateCategoriesDisplay() {
                const customCategories = loadCustomCategories();

                // Update income categories
                const incomeList = document.getElementById('incomeCategoriesList');
                if (incomeList) {
                    const allIncomeCategories = [...categories.income, ...customCategories.income];
                    incomeList.innerHTML = allIncomeCategories.map(cat => {
                        const isCustom = customCategories.income.includes(cat);
                        return `
                            <div class="flex items-center justify-between bg-gray-50 px-2 py-1 rounded text-xs">
                                <span>${cat}</span>
                                ${isCustom ? `<button onclick="removeCustomCategory('income', '${cat}')" class="text-red-500 hover:text-red-700 ml-2">×</button>` : ''}
                            </div>
                        `;
                    }).join('');
                }

                // Update expense categories
                const expenseList = document.getElementById('expenseCategoriesList');
                if (expenseList) {
                    const allExpenseCategories = [...categories.expense, ...customCategories.expense];
                    expenseList.innerHTML = allExpenseCategories.map(cat => {
                        const isCustom = customCategories.expense.includes(cat);
                        return `
                            <div class="flex items-center justify-between bg-gray-50 px-2 py-1 rounded text-xs">
                                <span>${cat}</span>
                                ${isCustom ? `<button onclick="removeCustomCategory('expense', '${cat}')" class="text-red-500 hover:text-red-700 ml-2">×</button>` : ''}
                            </div>
                        `;
                    }).join('');
                }
            }

            function renderAccounts() {
                const el = document.getElementById('accountsList');
                if (!el) return;

                if (!accounts || accounts.length === 0) {
                    el.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            <p class="text-gray-500 text-lg">No accounts yet</p>
                            <p class="text-gray-400 text-sm">Add your first account to start tracking</p>
                        </div>
                    `;
                    return;
                }

                console.log('Rendering', accounts.length, 'accounts to DOM');
                el.innerHTML = accounts.map(account => {
                    const typeIcons = {
                        'cash': '💵',
                        'bank': '🏦',
                        'credit': '💳',
                        'mtn-momo': '📱',
                        'telecel-cash': '📞',
                        'investment': '📈',
                        'asset': '🏠',
                        'debt': '💰'
                    };

                    const typeColors = {
                        'cash': 'bg-green-100 text-green-800 border-green-200',
                        'bank': 'bg-blue-100 text-blue-800 border-blue-200',
                        'credit': 'bg-red-100 text-red-800 border-red-200',
                        'mtn-momo': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                        'telecel-cash': 'bg-purple-100 text-purple-800 border-purple-200',
                        'investment': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                        'asset': 'bg-teal-100 text-teal-800 border-teal-200',
                        'debt': 'bg-orange-100 text-orange-800 border-orange-200'
                    };

                    const icon = typeIcons[account.type] || '💰';
                    const colorClass = typeColors[account.type] || 'bg-gray-100 text-gray-800 border-gray-200';
                    const balance = Number(account.balance || 0);
                    const isNegative = balance < 0;

                    return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 ${colorClass} rounded-full flex items-center justify-center text-lg">
                                        ${icon}
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">${account.name}</p>
                                        <p class="text-sm text-gray-500 capitalize">${account.type.replace('-', ' ')}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg ${isNegative ? 'text-red-600' : 'text-gray-900'}">
                                        ${currency}${balance.toFixed(2)}
                                    </p>
                                    <div class="flex space-x-2 mt-2">
                                        <button onclick="editAccount('${account.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                        <button onclick="deleteAccount('${account.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function editAccount(accountId) {
                const account = accounts.find(a => a.id === accountId);
                if (!account) return;

                // Populate modal with account data
                document.getElementById('accountName').value = account.name;
                document.getElementById('accountType').value = account.type;
                document.getElementById('accountBalance').value = account.balance;

                // Change button text and function
                const button = document.querySelector('#accountModal button[onclick*="addAccount"]');
                button.textContent = 'Update Account';
                button.setAttribute('onclick', `updateAccount('${accountId}')`);

                openAccountModal();
            }

            function updateAccount(accountId) {
                const name = document.getElementById('accountName').value.trim();
                const type = document.getElementById('accountType').value;
                const balance = parseFloat(document.getElementById('accountBalance').value) || 0;

                if (!name) {
                    alert('Please enter an account name');
                    return;
                }

                const accountIndex = accounts.findIndex(a => a.id === accountId);
                if (accountIndex === -1) return;

                // Check if account name already exists (excluding current account)
                if (accounts.some((acc, index) => index !== accountIndex && acc.name.toLowerCase() === name.toLowerCase())) {
                    alert('An account with this name already exists');
                    return;
                }

                accounts[accountIndex] = {
                    ...accounts[accountIndex],
                    name,
                    type,
                    balance
                };

                saveToFirebase();
                closeAccountModal();
                updateAccountSelectors();
                renderAccounts();
                updateFinancialPosition();
                alert('Account updated successfully!');
            }

            function deleteAccount(accountId) {
                // Prevent deletion if account has transactions
                const hasTransactions = transactions.some(t => t.account === accountId || t.fromAccount === accountId || t.toAccount === accountId);
                if (hasTransactions) {
                    alert('This account has transactions. Please reassign or delete them first.');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this account? This action cannot be undone.')) return;

                accounts = accounts.filter(a => a.id !== accountId);
                saveToFirebase();
                updateAccountSelectors();
                renderAccounts();
                updateFinancialPosition();
                alert('Account deleted successfully!');
            }

            // ============================================
            // ASSET MANAGEMENT FUNCTIONS
            // ============================================
            function renderAssets() {
                const el = document.getElementById('assetsList');
                if (!el) return;

                if (!assets || assets.length === 0) {
                    el.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            <p class="text-gray-500 text-lg">No assets yet</p>
                            <p class="text-gray-400 text-sm">Add your first asset to start tracking</p>
                        </div>
                    `;
                    updateAssetTotals();
                    return;
                }

                el.innerHTML = assets.map(asset => {
                    const categoryColors = {
                        'real-estate': 'bg-green-100 text-green-800 border-green-200',
                        'investment': 'bg-purple-100 text-purple-800 border-purple-200',
                        'vehicle': 'bg-blue-100 text-blue-800 border-blue-200',
                        'jewelry': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                        'loan': 'bg-orange-100 text-orange-800 border-orange-200',
                        'other': 'bg-gray-100 text-gray-800 border-gray-200'
                    };

                    const colorClass = categoryColors[asset.category] || categoryColors['other'];

                    return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 ${colorClass} rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${asset.category === 'real-estate' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>' :
                                              asset.category === 'investment' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>' :
                                              asset.category === 'vehicle' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>' :
                                              asset.category === 'loan' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>' :
                                              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>'}
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">${asset.name}</p>
                                        <p class="text-sm text-gray-500 capitalize">${asset.category.replace('-', ' ')} • ${asset.purchaseDate ? new Date(asset.purchaseDate).toLocaleDateString() : ''}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg ${asset.category === 'loan' && asset.value <= 0 ? 'text-green-600' : 'text-gray-900'}">
                                        ${asset.category === 'loan' && asset.value <= 0 ? 'Repaid' : currency + Number(asset.value || 0).toFixed(2)}
                                    </p>
                                    <div class="flex space-x-2 mt-2">
                                        <button onclick="editAsset('${asset.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                        <button onclick="deleteAsset('${asset.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                updateAssetTotals();
            }

            function updateAssetTotals() {
                let totalAssets = 0;
                let realEstate = 0;
                let investments = 0;
                let loans = 0;

                (assets || []).forEach(asset => {
                    const value = Number(asset.value || 0);
                    if (value > 0) {  // Only count assets with positive value
                        totalAssets += value;

                        if (asset.category === 'real-estate') {
                            realEstate += value;
                        } else if (asset.category === 'investment') {
                            investments += value;
                        } else if (asset.category === 'loan') {
                            loans += value;
                        }
                    }
                });

                const totalEl = document.getElementById('totalAssetsValue');
                const realEstateEl = document.getElementById('realEstateValue');
                const investmentsEl = document.getElementById('investmentsValue');
                const loansEl = document.getElementById('loansValue');

                if (totalEl) totalEl.textContent = currency + totalAssets.toFixed(2);
                if (realEstateEl) realEstateEl.textContent = currency + realEstate.toFixed(2);
                if (investmentsEl) investmentsEl.textContent = currency + investments.toFixed(2);
                if (loansEl) loansEl.textContent = currency + loans.toFixed(2);
            }

            function openAssetModal(assetId = null) {
                const modal = document.getElementById('assetModal');
                if (!modal) return;

                modal.classList.remove('hidden');

                if (assetId) {
                    // Edit mode
                    const asset = assets.find(a => a.id === assetId);
                    if (asset) {
                        document.getElementById('assetName').value = asset.name || '';
                        document.getElementById('assetCategory').value = asset.category || 'other';
                        document.getElementById('assetValue').value = asset.value || '';
                        document.getElementById('assetPurchaseDate').value = asset.purchaseDate || '';
                        document.getElementById('assetDescription').value = asset.description || '';
                        document.getElementById('assetModalTitle').textContent = 'Edit Asset';
                        document.getElementById('assetSubmitBtn').textContent = 'Update Asset';
                        document.getElementById('assetSubmitBtn').onclick = () => updateAsset(assetId);
                    }
                } else {
                    // Add mode
                    document.getElementById('assetName').value = '';
                    document.getElementById('assetCategory').value = 'other';
                    document.getElementById('assetValue').value = '';
                    document.getElementById('assetPurchaseDate').value = '';
                    document.getElementById('assetDescription').value = '';
                    document.getElementById('assetModalTitle').textContent = 'Add New Asset';
                    document.getElementById('assetSubmitBtn').textContent = 'Add Asset';
                    document.getElementById('assetSubmitBtn').onclick = addAsset;
                }
            }

            function closeAssetModal() {
                const modal = document.getElementById('assetModal');
                if (modal) modal.classList.add('hidden');
            }

            function addAsset() {
                const name = document.getElementById('assetName').value.trim();
                const category = document.getElementById('assetCategory').value;
                const value = parseFloat(document.getElementById('assetValue').value);
                const purchaseDate = document.getElementById('assetPurchaseDate').value;
                const description = document.getElementById('assetDescription').value;

                if (!name || isNaN(value) || value <= 0) {
                    alert('Please enter valid asset name and value');
                    return;
                }

                const newAsset = {
                    id: Date.now().toString(),
                    name,
                    category,
                    value,
                    purchaseDate,
                    description
                };

                assets.push(newAsset);
                saveToFirebase();
                closeAssetModal();
                renderAssets();
                updateFinancialPosition();
                alert('Asset added successfully!');
            }

            function updateAsset(assetId) {
                const asset = assets.find(a => a.id === assetId);
                if (!asset) return;

                const name = document.getElementById('assetName').value.trim();
                const category = document.getElementById('assetCategory').value;
                const value = parseFloat(document.getElementById('assetValue').value);
                const purchaseDate = document.getElementById('assetPurchaseDate').value;
                const description = document.getElementById('assetDescription').value;

                if (!name || isNaN(value) || value <= 0) {
                    alert('Please enter valid asset name and value');
                    return;
                }

                asset.name = name;
                asset.category = category;
                asset.value = value;
                asset.purchaseDate = purchaseDate;
                asset.description = description;

                saveToFirebase();
                closeAssetModal();
                renderAssets();
                updateFinancialPosition();
                alert('Asset updated successfully!');
            }

            function editAsset(assetId) {
                openAssetModal(assetId);
            }

            function deleteAsset(assetId) {
                if (!confirm('Are you sure you want to delete this asset?')) return;

                assets = assets.filter(a => a.id !== assetId);
                saveToFirebase();
                renderAssets();
                updateFinancialPosition();
                alert('Asset deleted successfully!');
            }

            // ============================================
            // LIABILITY MANAGEMENT FUNCTIONS
            // ============================================

            function renderLiabilities() {
                const el = document.getElementById('liabilitiesList');
                if (!el) return;

                if (!liabilities || liabilities.length === 0) {
                    el.innerHTML = `
                        <div class="text-center py-8">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p class="text-gray-500 text-lg">No liabilities yet</p>
                            <p class="text-gray-400 text-sm">Add your first liability to start tracking</p>
                        </div>
                    `;
                    updateLiabilityTotals();
                    return;
                }

                el.innerHTML = liabilities.map(liability => {
                    const typeColors = {
                        'bank-loan': 'bg-blue-100 text-blue-800 border-blue-200',
                        'credit-card': 'bg-red-100 text-red-800 border-red-200',
                        'personal-loan': 'bg-green-100 text-green-800 border-green-200',
                        'mortgage': 'bg-purple-100 text-purple-800 border-purple-200',
                        'other': 'bg-gray-100 text-gray-800 border-gray-200'
                    };

                    const colorClass = typeColors[liability.type] || typeColors['other'];

                    return `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-3 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 ${colorClass} rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${liability.type === 'bank-loan' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>' :
                                              liability.type === 'credit-card' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>' :
                                              liability.type === 'personal-loan' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>' :
                                              liability.type === 'mortgage' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>' :
                                              '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>'}
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">${liability.name}</p>
                                        <p class="text-sm text-gray-500 capitalize">${liability.type.replace('-', ' ')} • ${liability.startDate ? new Date(liability.startDate).toLocaleDateString() : ''}</p>
                                        ${liability.interestRate ? `<p class="text-xs text-orange-600">${liability.interestRate}% interest</p>` : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg ${liability.amount <= 0 ? 'text-green-600' : 'text-red-600'}">
                                        ${liability.amount <= 0 ? 'Paid Off' : currency + Number(liability.amount || 0).toFixed(2)}
                                    </p>
                                    <div class="flex space-x-2 mt-2">
                                        <button onclick="makeLiabilityPayment('${liability.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium">Pay</button>
                                        <button onclick="editLiability('${liability.id}')" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm font-medium">Edit</button>
                                        <button onclick="deleteLiability('${liability.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-medium">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                updateLiabilityTotals();
            }

            function updateLiabilityTotals() {
                let totalLiabilities = 0;
                let bankLoans = 0;
                let creditCards = 0;
                let personalLoans = 0;

                (liabilities || []).forEach(liability => {
                    const amount = Number(liability.amount || 0);
                    if (amount > 0) {
                        totalLiabilities += amount;

                        if (liability.type === 'bank-loan' || liability.type === 'mortgage') {
                            bankLoans += amount;
                        } else if (liability.type === 'credit-card') {
                            creditCards += amount;
                        } else if (liability.type === 'personal-loan') {
                            personalLoans += amount;
                        }
                    }
                });

                const totalEl = document.getElementById('liabilitiesTabTotalValue');
                const bankLoansEl = document.getElementById('bankLoansValue');
                const creditCardsEl = document.getElementById('creditCardsValue');
                const personalLoansEl = document.getElementById('personalLoansValue');

                if (totalEl) totalEl.textContent = currency + totalLiabilities.toFixed(2);
                if (bankLoansEl) bankLoansEl.textContent = currency + bankLoans.toFixed(2);
                if (creditCardsEl) creditCardsEl.textContent = currency + creditCards.toFixed(2);
                if (personalLoansEl) personalLoansEl.textContent = currency + personalLoans.toFixed(2);
            }

            function openLiabilityModal(liabilityId = null) {
                const modal = document.getElementById('liabilityModal');
                if (!modal) return;

                modal.classList.remove('hidden');

                if (liabilityId) {
                    // Edit mode
                    const liability = liabilities.find(l => l.id === liabilityId);
                    if (liability) {
                        document.getElementById('liabilityName').value = liability.name || '';
                        document.getElementById('liabilityType').value = liability.type || 'bank-loan';
                        document.getElementById('liabilityAmount').value = liability.amount || '';
                        document.getElementById('liabilityInterestRate').value = liability.interestRate || '';
                        document.getElementById('liabilityStartDate').value = liability.startDate || '';
                        document.getElementById('liabilityDueDate').value = liability.dueDate || '';
                        document.getElementById('liabilityDescription').value = liability.description || '';
                        document.getElementById('liabilityModalTitle').textContent = 'Edit Liability';
                        document.getElementById('liabilitySubmitBtn').textContent = 'Update Liability';
                        document.getElementById('liabilitySubmitBtn').onclick = () => updateLiability(liabilityId);
                    }
                } else {
                    // Add mode
                    document.getElementById('liabilityName').value = '';
                    document.getElementById('liabilityType').value = 'bank-loan';
                    document.getElementById('liabilityAmount').value = '';
                    document.getElementById('liabilityInterestRate').value = '';
                    document.getElementById('liabilityStartDate').value = '';
                    document.getElementById('liabilityDueDate').value = '';
                    document.getElementById('liabilityDescription').value = '';
                    document.getElementById('liabilityModalTitle').textContent = 'Add New Liability';
                    document.getElementById('liabilitySubmitBtn').textContent = 'Add Liability';
                    document.getElementById('liabilitySubmitBtn').onclick = () => addLiability();
                }
            }

            function closeLiabilityModal() {
                const modal = document.getElementById('liabilityModal');
                if (modal) modal.classList.add('hidden');
            }

            function addLiability() {
                const name = document.getElementById('liabilityName').value.trim();
                const type = document.getElementById('liabilityType').value;
                const amount = parseFloat(document.getElementById('liabilityAmount').value) || 0;
                const interestRate = parseFloat(document.getElementById('liabilityInterestRate').value) || 0;
                const startDate = document.getElementById('liabilityStartDate').value;
                const dueDate = document.getElementById('liabilityDueDate').value;
                const description = document.getElementById('liabilityDescription').value.trim();

                if (!name || amount <= 0) {
                    alert('Please enter a liability name and amount.');
                    return;
                }

                const liability = {
                    id: Date.now().toString(),
                    name,
                    type,
                    amount,
                    interestRate,
                    startDate,
                    dueDate,
                    description,
                    createdAt: new Date().toISOString()
                };

                liabilities.push(liability);
                saveToFirebase();
                renderLiabilities();
                updateFinancialPosition();
                closeLiabilityModal();
                alert('Liability added successfully!');
            }

            function updateLiability(liabilityId) {
                const liability = liabilities.find(l => l.id === liabilityId);
                if (!liability) return;

                const name = document.getElementById('liabilityName').value.trim();
                const type = document.getElementById('liabilityType').value;
                const amount = parseFloat(document.getElementById('liabilityAmount').value) || 0;
                const interestRate = parseFloat(document.getElementById('liabilityInterestRate').value) || 0;
                const startDate = document.getElementById('liabilityStartDate').value;
                const dueDate = document.getElementById('liabilityDueDate').value;
                const description = document.getElementById('liabilityDescription').value.trim();

                if (!name || amount < 0) {
                    alert('Please enter a valid liability name and amount.');
                    return;
                }

                liability.name = name;
                liability.type = type;
                liability.amount = amount;
                liability.interestRate = interestRate;
                liability.startDate = startDate;
                liability.dueDate = dueDate;
                liability.description = description;

                saveToFirebase();
                renderLiabilities();
                updateFinancialPosition();
                closeLiabilityModal();
                alert('Liability updated successfully!');
            }

            function deleteLiability(liabilityId) {
                if (!confirm('Are you sure you want to delete this liability?')) return;

                liabilities = liabilities.filter(l => l.id !== liabilityId);
                saveToFirebase();
                renderLiabilities();
                updateFinancialPosition();
                alert('Liability deleted successfully!');
            }

            function makeLiabilityPayment(liabilityId) {
                const liability = liabilities.find(l => l.id === liabilityId);
                if (!liability) return;

                // Create payment modal HTML
                const paymentModal = document.createElement('div');
                paymentModal.id = 'paymentModal';
                paymentModal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center p-2 md:p-4 z-50 overflow-y-auto';
                paymentModal.innerHTML = `
                    <div class="bg-white rounded-2xl md:rounded-3xl shadow-2xl max-w-md w-full p-4 md:p-6 my-4 md:my-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">Make Payment</h2>
                            <button onclick="this.closest('.fixed').remove()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-gray-600 mb-2">Paying towards: <strong>${liability.name}</strong></p>
                                <p class="text-sm text-gray-600 mb-4">Current balance: <strong>${currency}${liability.amount.toFixed(2)}</strong></p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Amount</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 font-medium">${currency}</span>
                                    <input type="number" id="paymentAmount" step="0.01" placeholder="0.00" class="w-full pl-16 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
                                <select id="paymentAccount" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                                    ${accounts.map(account => `<option value="${account.id}">${account.name} (${account.type})</option>`).join('')}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date & Time</label>
                                <input type="datetime-local" id="paymentDate" value="${new Date().toISOString().slice(0, 16)}" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                                <input type="text" id="paymentDescription" placeholder="e.g., Monthly payment, Extra payment" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            </div>

                            <button onclick="processLiabilityPayment('${liabilityId}')" class="w-full bg-gradient-to-r from-red-600 to-pink-600 text-white py-4 rounded-xl font-semibold text-lg hover:shadow-lg transition-shadow mt-6">
                                Record Payment
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(paymentModal);
            }

            function processLiabilityPayment(liabilityId) {
                const liability = liabilities.find(l => l.id === liabilityId);
                if (!liability) return;

                const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
                const paymentAccount = document.getElementById('paymentAccount').value;
                const paymentDate = document.getElementById('paymentDate').value;
                const paymentDescription = document.getElementById('paymentDescription').value.trim();

                if (isNaN(paymentAmount) || paymentAmount <= 0) {
                    alert('Please enter a valid payment amount.');
                    return;
                }

                if (paymentAmount > liability.amount) {
                    alert('Payment amount cannot exceed the current balance.');
                    return;
                }

                // Reduce the liability amount
                liability.amount -= paymentAmount;

                // Add a transaction record for the payment
                const transaction = {
                    id: Date.now().toString(),
                    type: 'expense',
                    category: 'Debt Payment',
                    amount: paymentAmount,  // Fixed: amount should be positive for expenses
                    account: paymentAccount,
                    description: paymentDescription || `Payment towards ${liability.name}`,
                    date: paymentDate,
                    liabilityId: liabilityId
                };

                transactions.push(transaction);

                // Update account balance
                const account = accounts.find(a => a.id === paymentAccount);
                if (account) {
                    console.log(`Account '${account.name}' balance BEFORE payment: ${account.balance}`);
                    console.log(`Payment amount: ${paymentAmount}`);
                    account.balance -= paymentAmount;
                    console.log(`Account '${account.name}' balance AFTER payment: ${account.balance}`);
                }

                // Close modal first
                const modal = document.getElementById('paymentModal');
                if (modal) modal.remove();

                saveToFirebase();
                
                // Re-render liabilities and other sections
                renderLiabilities();
                renderTransactions();
                renderAccounts();
                updateFinancialPosition();

                alert(`Payment of ${currency}${paymentAmount.toFixed(2)} recorded successfully!`);
            }

            function renderAnalytics() {
                updateAnalytics();
            }
            
            function showLiabilitiesBreakdown() {
                const modal = document.getElementById('liabilitiesBreakdownModal');
                const content = document.getElementById('breakdownContent');
                
                let liabilityItems = [];
                let totalLiabilities = 0;
                
                (liabilities || []).forEach(liability => {
                    const amount = Number(liability.amount || 0);
                    if (amount > 0) {
                        liabilityItems.push({name: liability.name, type: liability.type || 'other', amount: amount, category: 'Liability'});
                        totalLiabilities += amount;
                    }
                });
                
                (accounts || []).forEach(account => {
                    const balance = Number(account.balance || 0);
                    if (balance < 0) {
                        liabilityItems.push({name: account.name, type: 'account', amount: Math.abs(balance), category: 'Negative Account Balance'});
                        totalLiabilities += Math.abs(balance);
                    }
                });
                
                liabilityItems.sort((a, b) => b.amount - a.amount);
                
                if (liabilityItems.length === 0) {
                    content.innerHTML = '<div class="text-center py-8"><p class="text-gray-600 text-lg font-semibold">No Liabilities! 🎉</p></div>';
                } else {
                    content.innerHTML = `
                        <div class="bg-gradient-to-r from-red-500 to-pink-500 rounded-xl p-6 text-white mb-6">
                            <p class="text-sm opacity-90">Total Liabilities</p>
                            <p class="text-3xl font-bold mt-1">${currency}${totalLiabilities.toFixed(2)}</p>
                        </div>
                        <div class="space-y-3">
                            ${liabilityItems.map(item => {
                                const percentage = ((item.amount / totalLiabilities) * 100).toFixed(1);
                                return `
                                    <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-red-500">
                                        <div class="flex justify-between mb-2">
                                            <div><p class="font-semibold">${item.name}</p><p class="text-xs text-gray-500">${item.category}</p></div>
                                            <div class="text-right"><p class="font-bold text-red-600">${currency}${item.amount.toFixed(2)}</p><p class="text-xs text-gray-500">${percentage}%</p></div>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-red-500 h-2 rounded-full" style="width: ${percentage}%"></div></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
                modal.classList.remove('hidden');
            }
            
            function closeLiabilitiesBreakdown() {
                document.getElementById('liabilitiesBreakdownModal').classList.add('hidden');
            }

            function updateAnalytics() {
                const type = document.getElementById('analyticsType').value;
                const ctx = document.getElementById('analyticsChart').getContext('2d');
                const summaryEl = document.getElementById('analyticsSummary');

                // Destroy existing chart
                if (analyticsChart) {
                    analyticsChart.destroy();
                }

                let chartData = {};
                let chartConfig = {};

                if (type === 'category') {
                    // Spending by category
                    const categoryData = {};
                    transactions.filter(t => t.type === 'expense').forEach(t => {
                        const category = t.category || 'Uncategorized';
                        categoryData[category] = (categoryData[category] || 0) + Math.abs(t.amount);
                    });

                    chartConfig = {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(categoryData),
                            datasets: [{
                                data: Object.values(categoryData),
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                                    '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                                title: {
                                    display: true,
                                    text: 'Spending by Category'
                                }
                            }
                        }
                    };

                    summaryEl.innerHTML = `
                        <div class="bg-white rounded-xl shadow-md p-4">
                            <h3 class="text-lg font-semibold mb-3">Category Breakdown</h3>
                            ${Object.entries(categoryData).map(([category, amount]) => `
                                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                    <span class="text-gray-700">${category}</span>
                                    <span class="font-semibold text-gray-900">${currency}${amount.toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;

                } else if (type === 'monthly') {
                    // Monthly trend
                    const monthlyData = {};
                    transactions.forEach(t => {
                        const date = new Date(t.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = { income: 0, expense: 0 };
                        }
                        if (t.type === 'income') {
                            monthlyData[monthKey].income += t.amount;
                        } else if (t.type === 'expense') {
                            monthlyData[monthKey].expense += Math.abs(t.amount);
                        }
                    });

                    const sortedMonths = Object.keys(monthlyData).sort();
                    
                    chartConfig = {
                        type: 'line',
                        data: {
                            labels: sortedMonths.map(month => {
                                const [year, monthNum] = month.split('-');
                                return `${year}-${monthNum}`;
                            }),
                            datasets: [{
                                label: 'Income',
                                data: sortedMonths.map(month => monthlyData[month].income),
                                borderColor: '#10B981',
                                backgroundColor: '#10B98120',
                                tension: 0.4
                            }, {
                                label: 'Expenses',
                                data: sortedMonths.map(month => monthlyData[month].expense),
                                borderColor: '#EF4444',
                                backgroundColor: '#EF444420',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Monthly Income vs Expenses'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return currency + value.toFixed(0);
                                        }
                                    }
                                }
                            }
                        }
                    };

                    summaryEl.innerHTML = `
                        <div class="bg-white rounded-xl shadow-md p-4">
                            <h3 class="text-lg font-semibold mb-3">Monthly Summary</h3>
                            ${sortedMonths.map(month => {
                                const data = monthlyData[month];
                                const net = data.income - data.expense;
                                return `
                                    <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                        <span class="text-gray-700">${month}</span>
                                        <div class="text-right">
                                            <div class="text-sm text-green-600">+${currency}${data.income.toFixed(2)}</div>
                                            <div class="text-sm text-red-600">-${currency}${data.expense.toFixed(2)}</div>
                                            <div class="font-semibold ${net >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                ${net >= 0 ? '+' : ''}${currency}${net.toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;

                } else if (type === 'comparison') {
                    // Income vs Expense comparison
                    const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.abs(t.amount), 0);
                    
                    chartConfig = {
                        type: 'bar',
                        data: {
                            labels: ['Income', 'Expenses'],
                            datasets: [{
                                data: [totalIncome, totalExpense],
                                backgroundColor: ['#10B981', '#EF4444'],
                                borderColor: ['#059669', '#DC2626'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Total Income vs Expenses'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return currency + value.toFixed(0);
                                        }
                                    }
                                }
                            }
                        }
                    };

                    const netIncome = totalIncome - totalExpense;
                    summaryEl.innerHTML = `
                        <div class="bg-white rounded-xl shadow-md p-4">
                            <h3 class="text-lg font-semibold mb-3">Financial Overview</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-green-600">${currency}${totalIncome.toFixed(2)}</div>
                                    <div class="text-sm text-gray-600">Total Income</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-red-600">${currency}${totalExpense.toFixed(2)}</div>
                                    <div class="text-sm text-gray-600">Total Expenses</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold ${netIncome >= 0 ? 'text-green-600' : 'text-red-600'}">${netIncome >= 0 ? '+' : ''}${currency}${netIncome.toFixed(2)}</div>
                                    <div class="text-sm text-gray-600">Net Income</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                analyticsChart = new Chart(ctx, chartConfig);
            }
            
            // ============================================
            // EMAIL NOTIFICATION FUNCTIONS
            // ============================================
            
            function toggleEmailNotifications() {
                const enabled = document.getElementById('enableEmailNotifications').checked;
                const settingsDiv = document.getElementById('emailNotificationSettings');
                
                if (enabled) {
                    settingsDiv.classList.remove('hidden');
                } else {
                    settingsDiv.classList.add('hidden');
                }
            }
            
            function loadEmailSettings() {
                const saved = localStorage.getItem('emailNotifications');
                if (saved) {
                    emailNotifications = JSON.parse(saved);
                    document.getElementById('enableEmailNotifications').checked = emailNotifications.enabled;
                    document.getElementById('notificationEmail').value = emailNotifications.email || '';
                    document.getElementById('emailjsPublicKey').value = emailNotifications.emailjsPublicKey || '';
                    document.getElementById('emailjsServiceId').value = emailNotifications.emailjsServiceId || '';
                    document.getElementById('emailjsTemplateId').value = emailNotifications.emailjsTemplateId || '';
                    
                    if (emailNotifications.enabled) {
                        document.getElementById('emailNotificationSettings').classList.remove('hidden');
                    }
                    
                    // Initialize EmailJS if configured
                    if (emailNotifications.emailjsPublicKey) {
                        emailjs.init(emailNotifications.emailjsPublicKey);
                    }
                }
            }
            
            function saveEmailSettings() {
                emailNotifications.enabled = document.getElementById('enableEmailNotifications').checked;
                emailNotifications.email = document.getElementById('notificationEmail').value;
                emailNotifications.emailjsPublicKey = document.getElementById('emailjsPublicKey').value;
                emailNotifications.emailjsServiceId = document.getElementById('emailjsServiceId').value;
                emailNotifications.emailjsTemplateId = document.getElementById('emailjsTemplateId').value;
                
                localStorage.setItem('emailNotifications', JSON.stringify(emailNotifications));
                
                // Initialize EmailJS with new key
                if (emailNotifications.emailjsPublicKey) {
                    emailjs.init(emailNotifications.emailjsPublicKey);
                }
            }
            
            function recordTransactionForEmail(transaction) {
                if (!emailNotifications.enabled) return;
                
                const today = new Date().toDateString();
                if (!emailNotifications.pendingTransactions) {
                    emailNotifications.pendingTransactions = [];
                }
                
                emailNotifications.pendingTransactions.push({
                    ...transaction,
                    recordedAt: new Date().toISOString()
                });
                
                localStorage.setItem('emailNotifications', JSON.stringify(emailNotifications));
            }
            
            async function sendTransactionSummaryEmail() {
                if (!emailNotifications.enabled || !emailNotifications.email) return;
                if (!emailNotifications.pendingTransactions || emailNotifications.pendingTransactions.length === 0) return;
                
                // Check if EmailJS is configured
                if (!emailNotifications.emailjsPublicKey || !emailNotifications.emailjsServiceId || !emailNotifications.emailjsTemplateId) {
                    console.log('EmailJS not configured');
                    return;
                }
                
                const now = new Date();
                const hour = now.getHours();
                
                // Only send at 6 AM or 6 PM
                if (hour !== 6 && hour !== 18) return;
                
                // Check if we already sent today at this time
                const lastSent = emailNotifications.lastNotificationDate;
                const today = now.toDateString();
                const timeSlot = hour === 6 ? 'morning' : 'evening';
                const lastSentKey = `${today}-${timeSlot}`;
                
                if (lastSent === lastSentKey) return;
                
                // Prepare email content
                const transactionsList = emailNotifications.pendingTransactions.map(t => {
                    const date = new Date(t.date);
                    return `- ${t.type.toUpperCase()}: ${currency}${t.amount.toFixed(2)} - ${t.description || t.category} (${date.toLocaleString()})`;
                }).join('\n');
                
                const totalIncome = emailNotifications.pendingTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + Number(t.amount), 0);
                    
                const totalExpense = emailNotifications.pendingTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + Number(t.amount), 0);
                
                const emailParams = {
                    to_email: emailNotifications.email,
                    subject: `Transaction Summary - ${timeSlot === 'morning' ? 'Morning' : 'Evening'} Report`,
                    message: `Transaction Summary for ${today}\n\n` +
                            `Total Transactions: ${emailNotifications.pendingTransactions.length}\n` +
                            `Total Income: ${currency}${totalIncome.toFixed(2)}\n` +
                            `Total Expenses: ${currency}${totalExpense.toFixed(2)}\n` +
                            `Net: ${currency}${(totalIncome - totalExpense).toFixed(2)}\n\n` +
                            `Transactions:\n${transactionsList}`
                };
                
                try {
                    await emailjs.send(
                        emailNotifications.emailjsServiceId,
                        emailNotifications.emailjsTemplateId,
                        emailParams
                    );
                    
                    // Mark as sent and clear pending transactions
                    emailNotifications.lastNotificationDate = lastSentKey;
                    emailNotifications.pendingTransactions = [];
                    localStorage.setItem('emailNotifications', JSON.stringify(emailNotifications));
                    
                    console.log('Transaction summary email sent successfully');
                } catch (error) {
                    console.error('Failed to send email:', error);
                }
            }
            
            async function testEmailNotification() {
                saveEmailSettings();
                
                if (!emailNotifications.email) {
                    alert('Please enter your notification email address');
                    return;
                }
                
                if (!emailNotifications.emailjsPublicKey || !emailNotifications.emailjsServiceId || !emailNotifications.emailjsTemplateId) {
                    alert('Please configure all EmailJS settings');
                    return;
                }
                
                const emailParams = {
                    to_email: emailNotifications.email,
                    subject: 'Test Email - Budget Tracker Notifications',
                    message: 'This is a test email from your Budget Tracker Pro app.\n\nIf you received this, your email notifications are configured correctly!\n\nYou will receive transaction summaries at 6 AM and 6 PM daily.'
                };
                
                try {
                    await emailjs.send(
                        emailNotifications.emailjsServiceId,
                        emailNotifications.emailjsTemplateId,
                        emailParams
                    );
                    alert('✅ Test email sent successfully! Check your inbox.');
                } catch (error) {
                    console.error('Test email failed:', error);
                    alert('❌ Failed to send test email. Please check your EmailJS configuration.');
                }
            }
            
            // Check and send emails every hour
            function startEmailNotificationScheduler() {
                loadEmailSettings();
                
                // Check immediately
                sendTransactionSummaryEmail();
                
                // Then check every hour
                setInterval(() => {
                    sendTransactionSummaryEmail();
                }, 60 * 60 * 1000); // Every hour
            }

            // End of script - ensure HTML is properly closed
        </script>

    </body>
    </html>
